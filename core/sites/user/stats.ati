<?setPageConst('simplified',true);//***********************************************************************//*************************** Validate User *****************************//***********************************************************************loginCheck();if(!isAdmin() && strpos($_SESSION['userAdminPrivleges'],'stats') === false) redirect($_SESSION['lastPage'],'You do not have permissions to access this area!');//***********************************************************************//************************* Initialize Filters **************************//***********************************************************************//***********************************************************************//************************** Generate Results ***************************//***********************************************************************$_hits['users']['guestHits'] = 0;$_hits['users']['memberHits'] = 0;$rs = $_SERVER['serverdb']->execute('SELECT * FROM hits WHERE 1'.$Filters);if ($rs) while ($row = $rs->FetchRow()) {			//************************* Variable Initilization *************************		list($url,$params) = explode('?',$row['url']); //Extract parameters from urls containing "?"	$pos = strpos($url,'/',10); //ftp://a.us is 10 chars :-)	$domain = substr($url,0,$pos);	$path = substr($url,$pos);	$extPos = strrpos($url,'.'); //extensionPosition	if($extPos < $pos && $row['code'] == 200) { //File has no extension		$ati = true;	}	else {		$ati = false;		$ext = substr($path,$extPos);	}		//******************************** filters *********************************		if($_REQUEST['url'] && $_REQUEST['url'] != $path) continue; //file filter			//**************************************************************************	//*************************** Analyzer Mode ********************************	//**************************************************************************			if(!$_REQUEST['mode'] || $_REQUEST['mode'] == 'analyzer') {				//******************  pages ******************				if($ati) {			$_hits['summary']['pages'] += 1; //increment total page veiws						if($_hits['urls'][$domain]['pages'][$path]) { //increment page views				$_hits['urls'][$domain]['pages'][$path]['views'] += 1;			}			else { //Add page to array				$_hits['urls'][$domain]['hits'] += 1;				$_hits['summary']['pagesSeperate'] += 1;				$_hits['urls'][$domain]['pages'][$path] = array('views'=>1);			}		}				//****************** Users ******************				if($row['user']) { //People who don't allow cookies and who are accessing non files are ignored						if(strlen($row['user']) > 32) { //member				$hitType = 'memberHits';				$userType = 'members';			}			else { //guest				$hitType = 'guestHits';				$userType = 'guests';			}						if(!isset($_hits['users'][$userType][$row['user']])) { //increment total visitors				$_hits['users'][$hitType] += 1;			}						if(!isset($_hits['users']['ips'][$row['ip']])) { //increment total visitors				$_hits['summary']['visitors'] += 1;				$_hits['users']['ipHits'] += 1;			}						$_hits['users'][$userType][$row['user']]['userCookie'] = $row['user'];			$_hits['users'][$userType][$row['user']]['fileHits'] = $_hits['users'][$userType][$row['user']]['fileHits'] + 1;			if($ati) $_hits['users'][$userType][$row['user']]['pageHits'] = $_hits['users'][$userType][$row['user']]['pageHits'] + 1;			$_hits['users'][$userType][$row['user']]['lastDate'] = doDate($row['time'],'short');			$_hits['users'][$userType][$row['user']]['userIp'] = $row['ip'];			$_hits['users'][$userType][$row['user']]['userAgent'] = $row['agent'];						$_hits['users']['ips'][$row['ip']]['userCookie'] = $row['user'];			$_hits['users']['ips'][$row['ip']]['fileHits'] = $_hits['users'][$userType][$row['user']]['fileHits'] + 1;			if($ati) $_hits['users']['ips'][$row['ip']]['pageHits'] = $_hits['users']['ips'][$row['ip']]['pageHits'] + 1;			$_hits['users']['ips'][$row['ip']]['lastDate'] = doDate($row['time'],'short');			$_hits['users']['ips'][$row['ip']]['userIp'] = $row['ip'];			$_hits['users']['ips'][$row['ip']]['userAgent'] = $row['agent'];		}				//********************************** Hits ******************************				$_hits['summary']['hits'] += 1;				//Handle Pagination		if(!$pagination['hits']) $pagination['hits'] = func(_mod.'pagination','paginationSimple',50,'hitspage');						//Item is on page		if($_hits['summary']['hits'] >= $pagination['hits']['offset'] && $_hits['summary']['hits'] < $pagination['hits']['limit']) {			$_hits['visits'][$row['time'].$row['user']]['requestTime'] = $row['time'];			$_hits['visits'][$row['time'].$row['user']]['userCookie'] = $row['user'];			$_hits['visits'][$row['time'].$row['user']]['requestUrl'] = $domain.$path;			$_hits['visits'][$row['time'].$row['user']]['userAgent'] = $row['agent'];		}	}			//**************************************************************************	//*************************** Comparison Mode ******************************	//**************************************************************************			else if($_REQUEST['mode'] == 'comparison') {				//**************************** Monthly *********************************				$date = date("F Y",$row['time']);		if(!$_hits['monthlyComparison'][$date]['visitors']) $_hits['monthlyComparison'][$date]['visitors'] = 0;				//visitors		if(!$_hits['users'][$date][$row['user']]) { 			$_hits['users'][$date][$row['user']] = 1;			$_hits['monthlyComparison'][$date]['visitors'] += 1;			if($_hits['monthlyComparison'][$date]['visitors'] > $_hits['monthlyComparisonMax']) $_hits['monthlyComparisonMax'] = $_hits['monthlyComparison'][$date]['visitors'];		}				//Pages		if($ati) {			$_hits['monthlyComparison'][$date]['pages'] += 1;			if($_hits['monthlyComparison'][$date]['pages'] > $_hits['monthlyComparisonMax']) $_hits['monthlyComparisonMax'] = $_hits['monthlyComparison'][$date]['pages'];						if(!$_hits['urls'][$date][$row['url']]) {				$_hits['urls'][$date][$row['url']] = 1;				$_hits['monthlyComparison'][$date]['seperatePages'] += 1;				if($_hits['monthlyComparison'][$date]['seperatePages'] > $_hits['monthlyComparisonMax']) $_hits['monthlyComparisonMax'] = $_hits['monthlyComparison'][$date]['seperatePages'];			}		}				//**************************** Daily ***********************************				$date = date("m d",$row['time']);		if(!$_hits['dailyComparison'][$date]['visitors']) $_hits['dailyComparison'][$date]['visitors'] = 0;				//visitors		if(!$_hits['users'][$date][$row['user']]) { 			$_hits['users'][$date][$row['user']] = 1;			$_hits['dailyComparison'][$date]['visitors'] += 1;			if($_hits['dailyComparison'][$date]['visitors'] > $_hits['dailyComparisonMax']) $_hits['dailyComparisonMax'] = $_hits['dailyComparison'][$date]['visitors'];		}				//Pages		if($ati) {			$_hits['dailyComparison'][$date]['pages'] += 1;			if($_hits['dailyComparison'][$date]['pages'] > $_hits['dailyComparisonMax']) $_hits['dailyComparisonMax'] = $_hits['dailyComparison'][$date]['pages'];						if(!$_hits['urls'][$date][$row['url']]) {				$_hits['urls'][$date][$row['url']] = 1;				$_hits['dailyComparison'][$date]['seperatePages'] += 1;				if($_hits['dailyComparison'][$date]['seperatePages'] > $_hits['dailyComparisonMax']) $_hits['dailyComparisonMax'] = $_hits['dailyComparison'][$date]['seperatePages'];			}		}			}		//**************************************************************************	//*************************** User Mode ************************************	//**************************************************************************		else if($_REQUEST['mode'] == 'user') {		//Make sure they entered a user		if(!$_REQUEST['userCookie'] && (!$_REQUEST['user'] || $_REQUEST['user'] == 'User Name')) {			$_REQUEST['user'] = 'User Name';			$_errors .= '<br />			<div class="outer">			<div class="header">Notice:</div>			<div class="lcol"><h4>Please enter the username you would like to analyze in the box above.</h4></div>			</div><br />';			break;		}		//make sure it's a real user, and get the user's data		if($_REQUEST['user']) $user = renderUser($_REQUEST['user']); //only members have usernames!		if($_REQUEST['user']) $user = renderUser($_REQUEST['user'], 'member');				if(1) {			$errors .= '<li>The user you entered could not be found.</li>';		}	}}//***********************************************************************//**************************** Sort Results *****************************//***********************************************************************if(!$_REQUEST['mode'] || $_REQUEST['mode'] == 'analyzer') {	//Paginate and reverse (newest first) hits	$_hits['pagination']['hits'] = func(_mod.'pagination','pagination',$_hits['summary']['hits'],50,'hitspage');		//Sort Summary	if($_hits['summary']) ksort($_hits['summary']);}//***********************************************************************//*************************** Display Results ***************************//***********************************************************************setPageConst('title','ATIServer Statistical Logfile Analyzer');setPageConst('bct','<a href="/index">Home</a> > ATIServer Statistical Logfile Analyzer');setPageTpl('stats',_root.'/core/sites/user/_templates');setPageConst('_hits',$_hits);setPageConst('_errors',$errors);?>