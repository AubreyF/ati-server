<?setPagePref('deadEndPage','true');setPageConst('simplified','true');if ($_REQUEST['m'] == 'c') {	//HACK	if($_SESSION['messagePage'] == 'end') $_SESSION['message'] = ''; //Hide message box	if(isLoggedIn()) {		setPage('			<script type="text/javascript">window.location.href=\''.($_REQUEST['r'] ? base64_decode($_REQUEST['r']) : $_SESSION['lastPage']).'\'</script>			<b>ATIServer Login successful!</b><br />			<i>Initialising multidomain ATIServer session...</i>			<noscript>				<h4>Since your browser does not support Javascript, please remember to "log out" when you are done using the site!</h4>				<h2><a href="'.($_REQUEST['r'] ? base64_decode($_REQUEST['r']) : $_SESSION['lastPage']).'">>> Continue to Page</a></h2>			</noscript>');		setPagePref('template',false);		buildPage();	}	else {		setPageConst('title','Login Unsuccessful');		setPageConst('bct','<a href="/index">Home</a> > <a href="/user/index">ATI Tools</a> > Login');		setPageBlock('block','Login Unsuccessful!','		<h4>Your attempt to login to the ATI Network was unsuccessful.</h4>		<em>This was because your browser is rejecting the identification cookie which tells us that you are logged in.</em>		<p>Please tell your browser to allow us to set cookies, and then try again.</p>		<a href="login" class="lbtn"><< Back to Login</a>');		buildPage();	}}if(isLoggedIn()) redirect(($_REQUEST['r'] ? base64_decode($_REQUEST['r']) : $_SESSION['lastPage']),'You were already logged in');if ($_REQUEST['u'] && $_REQUEST['p']){	$row = renderUser("userName=".dbStr($_REQUEST['u'])." AND userPassword = ".dbStr($_REQUEST['p']), 'member,preFormatted');	if($row) {		$oldSession = $_SESSION;		//********************* Merge new session with old session data! **********************		$_SESSION = $row;		//********************* Handle permanent sessions **********************		if($_REQUEST['m'] == 1) $_SESSION['isPermanent'] = true;		//********************* Preserve old buffers! **********************		$_SERVER['serverdb']->execute("UPDATE buffers SET userId = '{$_SESSION['userId']}' WHERE userId = '{$oldSession['userId']}'");		$_SERVER['serverdb']->execute("DELETE FROM buffers WHERE bufferLast < '".(time() - (60 * 60 * 24))."'"); //Prune really old buffers		//********************* Log In Successful! **********************        redirect('/user/login-m-c'.($_REQUEST['r'] ? '-r-'.$_REQUEST['r'] : ''));   }   else $loginMessage = '<div class="etxt">Your Username / Password Combination could not be found</div>';}else if($_REQUEST['u'] || $_REQUEST['p']) $loginMessage = '<div class="etxt">Please enter both your username and your password</div>';if ($_REQUEST['lostPassword'] == 'worked')  			$lostPasswordMessage = '<b>Your ATI network password information has been sent to your email address!</b>';else if ($_REQUEST['lostPassword'] == 'forgotEmail')	$lostPasswordMessage = 'You forgot to enter your email address!';else if ($_REQUEST['lostPassword'] == 'failed')  		$lostPasswordMessage = '<b>The email address was not found.<br />You may need to register?</b>';//else													$lostPasswordMessage = 'Enter your email and we will send you your password!';setPageConst('title','Authentication');setPageConst('bct','<a href="/index">Home</a> > Authentication');if($_SESSION['hideRegistration']) {	setPage('		<div style="min-width:200px; max-width:400px; margin:auto;">			<div class="header">Log In:</div>			'.$loginMessage.'			<div class="content">			<form action="/user/login" method="post" class="outer narrow">				<div>					<input name="u" type="text" id="username" value="'.$_REQUEST['u'].'" />					Username:				</div>				<div>					<input name="p" type="password" id="password" />					Password:				</div>				<div>					<select name="m"><option value="0">Transient</option><option value="1"'.($_REQUEST['m'] == '1' ? ' selected' : '').'>Stay Logged In</option></select>					Mode:				</div>				<input name="r" type="hidden" value="'.$_REQUEST['r'].'" />				<input type="submit" name="Submit" value="Login!" class="bold" />			</form>			</div>			<br />			<div class="header">Forgot your password?</div>			 '.($lostPasswordMessage ? '<div class="etxt">'.$lostPasswordMessage.'</div>' : '').'			<div class="content">			 <form name="resetPassword" method="post" action="/user/passwordreset" class="outer narrow">			  <div>				 <input name="emailAddress" type="text" id="emailAddress" class="rflt"/>				 Your Email:			</div>			  <input name="Submit" type="submit" value="Find My Password!" class="bold" />			</form>			</div>		</div>	');}else {	setPage('	<table class="columns">	  <tr>		<td class="column">			<div class="header">Register:</div>			<div class="content">				<br />				<br />				<br />				<div class="itxt">Member registration has reached it\'s sunset</div>				<br />				<br />				<a href="http://marsxplr.com/view-14370" class="lbtn bold">Aubrey\'s Farewell</a>				<br />				<br />				PlexPedia is entering museum mode.				<br />				Thanks for your understanding.				<br />				<br />			</div>			<!--<div class="content">				<br />				<div class="itxt">First time user? Don\'t Worry!</div>				<br />				<a href="/user/register" class="lbtn bold">Register for Free!</a>				<br />				<b><ol>				<li>Click the "Register For Free" button</li>				<li>Fill in some details</li>				<li>Press submit</li>				</ol></b>				<em>You will then be automatically logged in,<br />and can get back to what you were doing!</em>				<br />				<br />			</div>-->		</td>		<td class="column" style="min-width:200px;">			<div class="header">Log In:</div>			'.$loginMessage.'			<div class="content">			<form action="/user/login" method="post" class="outer narrow">				<div>					<input name="u" type="text" id="username" value="'.$_REQUEST['u'].'" />					Username:				</div>				<div>					<input name="p" type="password" id="password" />					Password:				</div>				<div>					<select name="m"><option value="0">Transient</option><option value="1"'.($_REQUEST['m'] == '1' ? ' selected' : '').'>Stay Logged In</option></select>					Mode:				</div>				<input name="r" type="hidden" value="'.$_REQUEST['r'].'" />				<input type="submit" name="Submit" value="Login!" class="bold" />			</form>			</div>			<br />			<div class="header">Forgot your password?</div>			 '.($lostPasswordMessage ? '<div class="etxt">'.$lostPasswordMessage.'</div>' : '').'			<div class="content">			 <form name="resetPassword" method="post" action="/user/passwordreset" class="outer narrow">			  <div>				 <input name="emailAddress" type="text" id="emailAddress" class="rflt"/>				 Your Email:			</div>			<input name="Submit" type="submit" value="Find My Password!" class="bold" />			</form>			</div>		</td>	  </tr>	</table>	');}?>