<?function pmSend($userName,$subject,$text,$options=array()) {	//Init Vars	if(!$options['from']) {		$options['from'] = $_SESSION['userName'];		$options['fromEmail'] = $_SESSION['userEmail'];	}	//if(!$options['from']) $options['from'] = 'system';	//Multiple Recipients	if(strpos($userName, ',')) {		$userNames = explode(',', $_REQUEST['username']);	}	//Error checking	if(!$options['skipErrors']) {		if($userNames) {			if(count($userNames) > 20) {				$errors .= "<li>We're sorry, but you can't message more than 20 users at once...</li>";			}			else {				$i = 0;				foreach($userNames as $key=>$val) {					$users[$i] = renderMemberBasic(trim($val),'userName','userId, userName, userRealName, userEmail, autoForwardEnabled');					if(!$users[$i]['userId']) $errors .= '<li>The user You specified ('.$val.') could not be found</li>';					$i++;				}			}		}		else {			if(!$userName) $errors .= "<li>You need to specify who to send Your message to!</li>";			else $user = renderMemberBasic($userName,'userName','userId, userName, userRealName, userEmail, autoForwardEnabled');			if(!$user['userId']) $errors .= '<li>The user You specified ('.$userName.') could not be found</li>';		}		if(!$subject) $errors .= "<li>Your message needs a subject!</li>";		if(!$text) $errors .= "<li>You Forgot to fill in your message!</li>";		if($errors) return '<div class="ebox">Please retry submission:<ul>'.$errors.'</ul></div>';	}	else { //they skipped the error checking...		$user['userEmail'] = $options['userEmail']; //Currently used by registration to PM people before they are inserted into DB		$user['autoForwardEnabled'] = $options['autoForwardEnabled'];	}	//Send PM	if($users) foreach($users as $key => $val) {		$_SERVER['serverdb']->execute("		INSERT INTO  `pms`		(`from`, `to`, `date`, `subject`, `text`, `regarding`)		VALUES ('{$options['from']}',".dbStr($val['userName']).",'".time()."',".dbStr($subject).",".dbStr(nl2br($text)).",".dbStr(decrypt($options['regarding'],'url')).")		");		if($val['autoForwardEnabled']) autoForward($val, $subject, $text, $options['from'], $options['fromEmail']);	}	else {		$_SERVER['serverdb']->execute("		INSERT INTO  `pms`		(`from`, `to`, `date`, `subject`, `text`, `regarding`)		VALUES ('{$options['from']}',".dbStr($userName).",'".time()."',".dbStr($subject).",".dbStr(nl2br($text)).",".dbStr(decrypt($options['regarding'],'url')).")		");		if($user['autoForwardEnabled']) autoForward($user, $subject, $text, $options['from'], $options['fromEmail']);	}	return true;}function autoForward($user, $subject, $text, $from, $fromEmail) {		$textHeader = ucwords($user['userRealName']).": Based on your Private Messaging settings, this PM".($from ? ' sent to you by '.$from : '')." has been AutoForwarded to your email.\n\nDo NOT reply to this email!\r\nView & Reply to this PM at http://{$_SERVER['FAKE_HOST']}/user/pm-id-".$_SERVER['serverdb']->insert_id()."\r\n=========================================================\n\n\n";		if($from == 'robot')			$htmlHeader = '<div style="padding:10px; border:1px dashed #999999; background-color:#F2F2F2; margin-bottom:30px; font-weight:bold;">This ATI System message has been automatically forwarded to your email.<div style="font-size:13px; margin-top:5px;"><a href="http://'.$_SERVER['FAKE_HOST'].'/user/pm-id-'.$_SERVER['serverdb']->insert_id().'">>> View Message Online</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://'.$_SERVER['FAKE_HOST'].'/user/pm">>> View All Your Messages</a></div></div>';		else			$htmlHeader = '<div style="padding:10px; border:1px dashed #999999; background-color:#F2F2F2; margin-bottom:30px; font-weight:bold;">'.ucwords($user['userRealName']).': this message'.($from ? ' from '.ucwords($from) : '').' has been AutoForwarded to your email:<div style="font-size:13px; margin-top:5px;"><a href="http://'.$_SERVER['FAKE_HOST'].'/user/pm-mode-send-username-'.encrypt($from,'url').'-subject-'.encrypt('Re: '.str_replace('Re: ','',$subject),'url').'-inreplyto-'.$_SERVER['serverdb']->insert_id().'">>> Reply Online</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://'.$_SERVER['FAKE_HOST'].'/user/pm-id-'.$_SERVER['serverdb']->insert_id().'">>> View Online</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://'.$_SERVER['FAKE_HOST'].'/user/pm">>> View All Your Messages</a></div></div>';		$htmlFooter = '<div style="padding:10px; border:1px dashed #999999; background-color:#F2F2F2; margin-top:30px; font-size:10px; font-style:italic;">If you don\'t want messages to be automatically forwarded to your email, please <a href="http://'.$_SERVER['FAKE_HOST'].'/user/editprofile">Change your AutoForward Settings</a></div>';		/*		$headers .= "From: Autoforward@".ucwords($_SERVER['FAKE_HOST'])."\nReply-To: Autoforward@".ucwords($_SERVER['FAKE_HOST']);		$headers .= "\nMIME-Version: 1.0\nContent-Type: multipart/alternative; boundary=\"alt-".($random_hash = md5(date('r', time())))."\"\n\nThis is a multi-part message in MIME format.\n\n";		$message .= "--alt-".$random_hash."\nContent-Type: text/plain; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n\n";		$message .= trim($textHeader.strip_tags($text));		$message .= "\n\n--alt-".$random_hash."\nContent-Type: text/html; charset=\"iso-8859-1\"\nContent-Transfer-Encoding: 7bit\n\n";		$message .= trim($htmlHeader.((strpos($text,'<br') || strpos($text,'<div')) ? $text : nl2br($text)).$htmlFooter);		$message .= "\n\n--alt-".$random_hash."--";		mail($user['userEmail'], $subject.($from != 'robot' ? ' - from '.ucwords($from) : ''), $message, $headers);		*/		$message .= "From: AutoForwarded Message <mailbot@plexpedia.com>\nTo: ".$user['userEmail'].($fromEmail != "" ? "\nReply-To: ".$fromEmail : '')."\nSubject: ".$subject;		$message .= "\nMIME-Version: 1.0\nContent-Type: multipart/alternative; boundary=\"alt-".($random_hash = md5(date('r', time())))."\"\n\nThis is a multi-part message in MIME format.\n\n";		$message .= "--alt-".$random_hash."\nContent-Type: text/plain;\nContent-Transfer-Encoding: 7bit\n\n";		$message .= trim($textHeader.strip_tags($text));		$message .= "\n\n--alt-".$random_hash."\nContent-Type: text/html;\nContent-Transfer-Encoding: 7bit\n\n";		$message .= trim($htmlHeader.((strpos($text,'<br') || strpos($text,'<div')) ? $text : nl2br($text)).$htmlFooter);		$message .= "\n\n--alt-".$random_hash."--";		require_once _root.'/serv/includes/aws_sdk_1.3.3/sdk.class.php';		$email = new AmazonSES($_SERVER['amazon_web_services']['key'], $_SERVER['amazon_web_services']['secret_key']);		$response = $email->send_raw_email(array('Data' => base64_encode($message)));		//if(!$response->isOK()) var_dump($response,true);}?>