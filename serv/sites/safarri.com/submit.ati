<?//Disable Return key submission :-)setPage('<script language="JavaScript" type="text/javascript">  function checkKey(evt) {    var evt  = (evt) ? evt : ((event) ? event : null);    var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);    if((evt.keyCode == 13) && (node.type=="text")) {return false;}  }  document.onkeypress = checkKey;</script>','head');//****************************************************************************************//*************** Section 1, set up initial variables and validate user! *****************//****************************************************************************************setPageConst('simplified',true);//setPageConst('searchBox','','skin');$edidKey = '1t2o3p4s5e6c7r8e9t0esrtryq4y48423t85948ghtvbdf3245skjsdbv7dsfk7509jdsafgd';if(isAdmin() && !$_REQUEST['edid']) $adminisEditing = true;else if($_REQUEST['id'] && $_SESSION['userId'] != $_SERVER['db']->getOne("SELECT usid FROM classifieds_ads WHERE id = ".$_REQUEST['id']) && $_REQUEST['edid'] != sha1($edidKey.$_REQUEST['id'])) redirect($_SESSION['lastPage'],'You did not have sufficient permission to edit the previous classified.');if($_REQUEST['cat'] && $_SERVER['db']->getOne("SELECT nonSubmittable FROM classifieds_categories WHERE id = '{$_REQUEST['cat']}'")) redirect($_SESSION['lastPage'],'<b>The category you selected was invalid</b><br />Please select a different category!');if($_SESSION['safarriStore']['id'] && (($_SESSION['safarriStore']['allowAnonymous'] != 1 && $_REQUEST['anonymous'] != false) || ($_SESSION['safarriStore']['allowRegular'] != 1 && !isAdmin() && $_SESSION['safarriStore']['usId'] != $_SESSION['userId'] && !$_SERVER['db']->getOne("SELECT userName FROM store_contributors WHERE userName = '{$_SESSION['userName']}' AND storeId = '{$_SESSION['safarriStore']['id']}'")))) redirect('/index','You do not have permission to submit a classified in this store!'); //we are in a store, and are doing something that is not allowedif(!$_REQUEST['step'] && isLoggedIn()) $_REQUEST['step'] = 2;else if($_REQUEST['step'] && !$_REQUEST['anonymous']) loginCheck('<b>Please Log In or Register to submit your classified.</b><br /><em>Don\'t want to login? <a href="/submit-step-'.$_REQUEST['step'].'-anonymous-true">Submit an anonymous classified instead!</a></em>','end');if(!$_REQUEST['id']) {	$_SERVER['db']->execute("DELETE FROM classifieds_ads WHERE soldDate = -1 AND date < '".(time() - (60 * 60 * 24))."'"); //"Prune" dud (-1) classifieds over 1 day old	$_SERVER['db']->execute("DELETE FROM classifieds_ads WHERE soldDate != 0 AND soldDate < '".(time() - (60 * 60 * 24 * 90))."'"); //"Prune" expired classifieds over 90 days old}//*********************** Update Quantity Request ******************************if($_REQUEST['qty'] && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to update the quantity of the previous ad'); //make sure they are allowed to edit!	if($_REQUEST['qty'] == 'inc') $mode = '+';	else $mode = '-';	$_SERVER['db']->execute('UPDATE classifieds_ads SET qty = qty '.$mode.' 1 WHERE id = '.$_REQUEST['id']);	redirect($_SESSION['lastPage']);}//**************************** Renew Request ***********************************if($_REQUEST['step'] == 'renew' && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to renew the quantity of the previous ad'); //make sure they are allowed to edit!	if($ad['soldDate'] > (time() + 10)) redirect($_SESSION['lastPage'],'<em>Your classifed has not yet expired!</em><br /><b>Please wait till your classifieds expires before renewing it.</b>');	if(!$ad['duration']) redirect($_SESSION['lastPage'],'<em>Your classifed has no duration set!</em><br /><b>Please press "Edit Ad", and set a duration for your ad.</b>');	$_SERVER['db']->execute('	UPDATE classifieds_ads SET date = '.time().', soldDate = '.(time() + ($ad['duration'] * 60 * 60 * 24)).'	WHERE id = '.$_REQUEST['id']);	redirect($_SESSION['lastPage']);}//*********************** Mark Ad Sold Request *********************************if($_REQUEST['step'] == 'marksold' && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to sell the previous ad'); //make sure they are allowed to edit!   	$_SERVER['db']->execute('UPDATE classifieds_ads SET soldDate = '.time().', status = 2 WHERE id = '.$_REQUEST['id']);	redirect($_SESSION['lastPage']);}//*********************** Mark Ad Sale Pending Request *********************************if($_REQUEST['step'] == 'markpending' && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to sell the previous ad'); //make sure they are allowed to edit!   	$_SERVER['db']->execute('UPDATE classifieds_ads SET status = 1 WHERE id = '.$_REQUEST['id']);	redirect($_SESSION['lastPage']);}//*********************** Delete Ad Request *********************************if($_REQUEST['step'] == 'markdelete' && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to sell the previous ad'); //make sure they are allowed to edit!   	$_SERVER['db']->execute('UPDATE classifieds_ads SET status = 3 WHERE id = '.$_REQUEST['id']);	redirect($_SESSION['lastPage']);}//*********************** Mark Ad Unsold Request *******************************if($_REQUEST['step'] == 'markunsold' && $_REQUEST['id']) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['usid'] != $_SESSION['userId'] && !isAdmin()) redirect($_SESSION['lastPage'],'You did not have permission to unsell the previous ad'); //make sure they are allowed to edit!	$_SERVER['db']->execute('	UPDATE classifieds_ads SET		soldDate = \''.(($ad['duration']) ? ($ad['date'] + ($ad['duration'] * 60 * 60 * 24)) : '') .'\',		status = 0	WHERE id = \''.$_REQUEST['id'].'\'');	redirect($_SESSION['lastPage']);}//*********************** BAN Ad Request ********************************if($_REQUEST['step'] == 'ban' && $_REQUEST['id'] && isAdmin()) {	$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);	if($ad['banText']) { //Ad is already banned - we are unbanning		if($ad['anonymous_user_details']) {			$user = unserialize($ad['anonymous_user_details']);			$time = $ad['date'] + ($user['duration'] * 60 * 60 * 24);		}		else $time = 0;		$_SERVER['db']->execute('UPDATE classifieds_ads SET soldDate = '.$time.', banText = \'\' WHERE id=\''.$_REQUEST['id'].'\'');		//buildPage();		redirect($_SESSION['lastPage']);	}	$_SERVER['db']->execute('UPDATE classifieds_ads SET soldDate = '.time().', banText = \''.$_REQUEST['banreason'].'\' WHERE id=\''.$_REQUEST['id'].'\'');	buildPage();	/*	//if($_REQUEST['submit']) {		$_SERVER['db']->execute('UPDATE classifieds_ads SET soldDate = '.time().', banText = \''.$_REQUEST['banreason'].'\' WHERE id=\''.$_REQUEST['id'].'\'');		buildPage();		//redirect($_SESSION['lastPage']);	}	if(!$ad['anonymous_user_details']) {		$level = 'member';		$xtra = '<br /><input type="checkbox" name="banuser" value="banuser" />Ban user\'s account as well			';	}	else {		$level = 'guest';	}	$user = renderUser($ad['usid'], $level.',userId');	setPageConst('title','Ban Ad!');	setPageConst('bct','<a href="/index">Home</a> > Ban Ad');	setPage(	pFunc('block','Ban Ad','	<div class="lbar">		<a href="'.$_SESSION['lastPage'].'"><< Back to Last Page</a><a href="/ad-'.$_REQUEST['id'].'"><< Back to Ad</a>	</div>	<b>You Are now banning an ad on Safarri.</b>	'.pFunc('columns','narrow','		<div class="header">Cancel</div>		<br />		<em>If you do not want to disable this ad:</em>		<br /><br /><br /><br />		<div class="boldBorder"><input class="input" type="button" value="Cancel" onClick="window.location=\''.$_SESSION['lastPage'].'\'" class="bold"></div>		<br /><noscript><a href="'.$_SESSION['lastPage'].'">(Your browser does not support javascript, so please click this link to cancel)</a></noscript>	','		<div class="header">Ban Ad</div>		<form method="post">		<br />Reason for Disabling:<br />		<textarea name="banreason" class="input">No item for sale, just promotional.</textarea>		<b>		<!--<input type="checkbox" name="banothers" value="banothers" /> Ban user\'s other ads as well		'.$xtra.'-->		</b>		<div class="boldBorder"><input class="input" type="submit" name="submit" value="Continue" class="bold"></div>		</form>	').'	<br /><br />	<div class="header">Ad Details:</div>	<div class="quoteText">'.print_r($ad,true).'</div>	<div class="header">User Details:</div>	<div class="quoteText">'.print_r($user,true).'</div>	'));	buildPage();	*/}if(!$_REQUEST['step']) { //The user is not logged in, and they have not selected the "anonymous" option...	if(!$_SESSION['safarriStore']['id'] || $_SESSION['safarriStore']['allowAnonymous'] == true) {		$buttons .= '		<td class="column">		<a class="hover" href="/submit-anonymous-true-step-2" onMouseOver="setHelp(\'Anonymous:\',\'<b>Press for an anonymous classified.</b><br /><br />Anonymous classifieds are totally easy, but not quite as powerful as registered classifieds.\')" onMouseOut="clearHelp()">			<div class="header">>> Submit Anonymous Classified</div>			<div class="content" style="min-height:200px;">				<br />				<div class="htxt">Quick and Easy</div>				<br />				<ul class="desc slst" style="text-align:left; padding-left:50px;">					<li>Great for first time users</li>					<li>You don\'t need to bother with usernames or passwords</li>					<li>Your classified will run 3, 7, 14, or 21 days, and then delete itself automatically.</li>					<li>Buyers will contact you through the phone.</li>					<li>The perfect way to compliment a newspaper ad with a full description and tons of pictures!</li>				</ul>			</div>		</a>		</td>';	}	setPageConst('title','Submit: Step 1 of 3!');	setPageConst('bct','<a href="/index">Home</a> > Sell: Step 1 of 3');	setPage(	pFunc('blockFancy','Submit Your Totally Free Classified - Step 1 of 3','&nbsp;		<table class="columns">		  <tr>			'.$buttons.'			<td class="column">			<a class="hover" href="/submit-step-2" onMouseOver="setHelp(\'Registered:\',\'<b>Press for a registered classified.</b><br /><br />Registered classifieds give you the full power of Safarri, but require registration for greater security.\')" onMouseOut="clearHelp()">				<div class="header">>> Submit Registered Classified</div>				<div class="content" style="min-height:200px;">					<br />					<div class="htxt">Power Seller</div>					<br />					<ul class="desc slst" style="text-align:left; padding-left:50px;">					  <li>Your classified will run until it sells</li>					  <li>You control contact and payment info</li>					  <li>Manage this ad in your control panel - a powerful command center to keep track of all your ads</li>					  <li>Perfect for when you have lots of items to sell</li>					  '.(!isLoggedIn() ? '<li>Requires Registration</li>' : '').'					</ul>				</div>			</a>			</td>		  </tr>		</table>	')	);	setPageBlock('blockHelp','Welcome:','<b>Submitting a classified on Safarri is easy, free, and totally fun!</b><br /><br />I will give you helpful tips as you create your classified.<br /><br />Select <b>Anonymous</b> or <b>Registered</b> to get started!</b>');	buildPage();}//****************************************************************************************//******************************* The user is "Anonymous" ********************************//****************************************************************************************if($_REQUEST['anonymous'] == true) {	//****************************************************************************	//*********************** Step 3 of 3 of ad submission ************************	//****************************************************************************	if($_REQUEST['step'] == 3 || $_REQUEST['step'] == 'modify') {		$ad = $_SERVER['db']->getRow("SELECT * FROM classifieds_ads WHERE id=".$_REQUEST['id']);		if(!$ad['usid'] || $_REQUEST['edid']) $ad['usid'] = $_SESSION['userId']; //no userid means this is the submitter - edid means this is not the admin editing someone else's ad		$user = unserialize($ad['anonymous_user_details']);		if($_POST['userPhone']) $_POST['userPhone'] = undoPhone($_POST['userPhone']); //Remove dashes, etc		if($_POST['submit']) {			if($_POST['submit'] == '<< Clear All Images') {				$i = 0;				while ($i < 16) {					$temp1 = 'pic'.$i;					$ad[$temp1] = '';					$_FILES['pic'.$i] = '';					$i++;				}				$message = '<div class="ebox"><h3>Your Images were successfully cleared!</h3></div>';			}			else if($_POST['submit'] == '>> Update Preview Images') $message = '<div class="ebox"><h3>Your Images were successfully uploaded!</h3></div>';			else if($_POST['submit'] == 'Change Type to Registered' || $_POST['submit'] == 'Change Category') { }			else {				$weAreSubmitting = true;				if(!$_POST['title'])		$errors .= "<li>You forgot to enter the Title!</li>";				if(!$_POST['duration'])		$errors .= "<li>You forgot to enter the Item's Duration!</li>";				if($_POST['duration'] != 3 && $_POST['duration'] != 7 && $_POST['duration'] != 14 && $_POST['duration'] != 21 && $_POST['duration'] != 90) $errors .= "<li>The item's duration is out of range! Please select a valid duration.</li>";				$_POST['price'] = preg_replace("/[^0-9\.]/","",$_POST['price']); //strip $ signs, etc...				if(!$_POST['type'])			$errors .= "<li>You didn't enter the type of listing!</li>";				if(!$_POST['cat'])			$errors .= "<li>You forgot to supply the category!</li>";				if(!$_POST['description'] && !$_POST['features']) $errors .= "<li>Your item needs at least either a description or a list of features!</li>";				if(!$_POST['userPhone'])	$errors .= "<li>You forgot to enter your phone number!</li>";				if($_POST['submit'] != 'Ignore Possible Errors') {					if(strlen($_POST['userPhone']) < 10)	$notes .= '<li>Your phone number does not appear valid!</li>';					/* if($_POST['userEmail'] && !checkEmail($_POST['userEmail'])) $notes .= "<li>Your email address could not be validated!</li>";*/				}			}			$i = 0;			$i2 = 0;			$i3 = 0;			while ($i < 16) {				$temp1 = 'pic'.$i2;				if($_FILES['pic'.$i]['size']) { //newly selected images overwrite					$i3++;					$image = func(_mod.'imageuploader','imageuploader','pic'.$i,400,300);					if($image == 1) 		$errors .= "<li>Image # {$i3}: you forgot to select an image file!<br /><em>(Please click the browse button)</em></li>";					else if($image == 2) 	$errors .= "<li>Image # {$i3}: the file you selected was not an image!<br /><em>(Please select a different file)</em></li>";					else if($image == 3) 	$errors .= "<li>Image # {$i3}: errors were experienced while processing your image!<br /><em>(Please try again)</em></li>";					else {						$ad[$temp1] = $image;					}				}				$i++;				if($ad[$temp1]) $i2++;			}			if($_POST['location']) {				$location = func(_mod.'location','getLocation',$_REQUEST['location']);				if(!$location) $errors .= "<li>Your location could not be located!</li>";			}			if($_POST['features']) {				$lines = preg_split('`[\n\r]+`', trim($_POST['features']));				$_POST['features'] = '';				foreach($lines as $line) $_POST['features'] .= "<li>$line</li>" ;			}			if(!$errors && !$notes) {				if($_REQUEST['step'] == 'modify' && $weAreSubmitting)	$ad['editDate'] = time();				if(!$ad['submitDate'] && $weAreSubmitting)				$ad['submitDate'] = time();				//********* Get User Details!!!!! ***********				if(!$adminisEditing) {					$user['ip'] = $_SERVER["HTTP_X_FORWARDED_FOR"];					$user['proxy'] = $_SERVER["REMOTE_ADDR"];					$user['host'] = @gethostbyaddr($_SERVER["HTTP_X_FORWARDED_FOR"]);				}				$user['userPhone'] = $_POST['userPhone'];				$user['userName'] = $_POST['userName'];				$user['extraInfo'] = $_POST['extraInfo'];				if($_POST['userEmail']) $user['userEmail'] = $_POST['userEmail'];				$srUser = serialize($user); //Compress user info for storing in a database				$sql = '					REPLACE INTO classifieds_ads SET					id = '.dbStr($_REQUEST['id']).',					cid = '.dbStr($_REQUEST['cat']).',					title = '.dbStr($_POST['title']).',					type = '.dbStr($_POST['type']).',					features = '.dbStr($_POST['features']).',					description = '.dbStr(nl2br($_POST['description'])).',					price = '.dbStr($_POST['price']).',					priceType = '.dbStr($_POST['priceType']).',					usid = '.dbStr($ad['usid']).',					town = '.dbStr($location['city']).',					country = '.dbStr($location['state']).',					lat = '.dbStr($location['latitude']).',					lon = '.dbStr($location['longitude']).',					xtraLocation = '.dbStr($_POST['extlocation']).',					qty = '.dbStr($_POST['quantity']).',					anonymous_user_details = '.dbStr($srUser).',					pic0 = '.dbStr($ad['pic0']).',					pic1 = '.dbStr($ad['pic1']).',					pic2 = '.dbStr($ad['pic2']).',					pic3 = '.dbStr($ad['pic3']).',					pic4 = '.dbStr($ad['pic4']).',					pic5 = '.dbStr($ad['pic5']).',					pic6 = '.dbStr($ad['pic6']).',					pic7 = '.dbStr($ad['pic7']).',					pic8 = '.dbStr($ad['pic8']).',					pic9 = '.dbStr($ad['pic9']).',					pic10 = '.dbStr($ad['pic10']).',					pic11 = '.dbStr($ad['pic11']).',					pic12 = '.dbStr($ad['pic12']).',					pic13 = '.dbStr($ad['pic13']).',					pic14 = '.dbStr($ad['pic14']).',					pic15 = '.dbStr($ad['pic15']).',					thumb0 = '.dbStr(func(_mod.'imageuploader','getThumbnailImageName',$ad['pic0'])).',					view = '.dbStr($ad['view']).',					storeid = '.dbStr($_SESSION['safarriStore']['id']).',					duration = '.dbStr($_POST['duration']).',					date = '.dbStr(time()).',					submitDate = '.dbStr($ad['submitDate']).',					editDate = '.dbStr($ad['editDate']).',					soldDate = '.dbStr(($_POST['duration'] ? (time() + 60 * 60 * 24 * $_POST['duration']) : ($weAreSubmitting ? 0 : -1))).',					status = '.($ad['status'] ? $ad['status'] : 0).',					premier = '.($ad['premier'] ? $ad['premier'] : 0).'				';				$_SERVER['db']->execute($sql);				if(!$_REQUEST['id']) $_REQUEST['id'] = $_SERVER['db']->insert_id();				if(!$adminisEditing) $_REQUEST['edid'] = sha1($edidKey.$_REQUEST['id']); //Admin is not editing someone else's ad				if($_SERVER['db']->errorMsg()) {					$errors .= '<li>There were errors inserting your ad in the database. We apioligise for the inconvience. Tech support has been notified, and we are working on fixing the problem.</li>';	mail('admin@safarri.com', 'Safarri Error: Database problem',	'Somebody got the create ad page to crash! The below database error:	'.$_SERVER['db']->errorMsg().'	was encountered with the below sql:	'.$sql);				}				if($_POST['submit'] == 'Change Type to Registered') redirect('/submit-id-'.$_REQUEST['id'].'-step-3-edid-'.$_REQUEST['edid']);				if($_POST['submit'] == 'Change Category') redirect('/submit-id-'.$_REQUEST['id'].'-edid-'.$_REQUEST['edid'].'-step-2-anonymous-true');			} if($errors) {				$message = '<div class="ebox"><h3>Please Retry Your Submission:</h3><ul>'.$errors.'</ul></div>';			} else if($notes && $_POST['submit'] != 'Ignore Possible Errors') {				$message = '<div class="nbox"><h3>There were possible errors with Your submission:</h3>				<ul>'.$notes.'</ul>				<b>Please either fix the errors and press submit again, or:</b><br /><br />				<div class="boldBorder"><input class="bold" name="submit" type="submit" value="Ignore Possible Errors"></div></div><br />';			} else if($weAreSubmitting) {				if($_POST['userEmail']) { //Send them email					require_once _root.'/serv/includes/aws_sdk_1.3.3/sdk.class.php';					$email = new AmazonSES($_SERVER['amazon_web_services']['key'], $_SERVER['amazon_web_services']['secret_key']);					$response = $email->send_email(						'Safarri <mailbot@plexpedia.com>',	// From						array('ToAddresses' => $_POST['userEmail']), // To						array( // Message (long form)							'Subject.Data' => 'Item Posted: '.$_POST['title'],							'Body.Text.Data' =>								"You have just posted an anonymous classified to ".$_SESSION['storeName']." titled \"{$_POST['title']}\".\n\n".								"You can edit this classified, mark it as sold, or renew it once it expires (in ".$_POST['duration']." days) at:\n\n".								"===========================================================\n\n".								"http://".$_SERVER['FAKE_HOST']."/ad-default-".$_REQUEST['id']."-edid-".$_REQUEST['edid']."\n\n".								"===========================================================\n\n".								"Thanks for using ".$_SESSION['storeName']."!\n\n".								"(Do not reply to this email, as it was sent from an unmonitored mailbox.)\n".								"For help using ".$_SESSION['storeName'].", please visit the help section at:\n".								"http://".$_SERVER['FAKE_HOST']."/tips",						)					);				}				//***************** It Worked! ********************				redirect('/ad-default-'.$_REQUEST['id'].'-edid-'.$_REQUEST['edid']);			}		}		if($ad) {  //they are modifying their classified			if(!$_POST) {				$user = unserialize($ad['anonymous_user_details']);				$_POST['userPhone'] = $user['userPhone'];				$_POST['userName'] = $user['userName'];				$_POST['extraInfo'] = $user['extraInfo'];				$_POST['title'] = $ad['title'];				$_POST['price'] = $ad['price'];				$_POST['type'] = $ad['type'];				$_POST['priceType'] = $ad['priceType'];				$_POST['town'] = $ad['town'];				$_POST['quantity'] = $ad['qty'];				$_POST['country'] = $ad['country'];				$_POST['extlocation'] = $ad['xtraLocation'];				$_POST['description'] = $ad['description'];				$_POST['features'] = $ad['features'];				$_POST['duration'] = $ad['duration'];				if($ad['town'] && $ad['country']) $_POST['location'] =  $ad['town'].', '.$ad['country'];			}			$_POST['description'] = str_replace("<br />","",$_POST['description']);			$_POST['features'] = str_replace(array('<li>','</li>'),array('',"\n"),$_POST['features']);			if(!$_REQUEST['cat']) $_REQUEST['cat'] = $ad['cid']; //do not overwrite the category if they already have one!		}		if($ad['usid'] == $_SESSION['userId']) {			if(!$_POST['location']) $_POST['location'] = $_SESSION['userZip'];			if(!$_POST['userPhone']) $_POST['userPhone'] = $_SESSION['userPhone'];			if(!$_POST['userEmail'] && !$user['userEmail']) $_POST['userEmail'] = $_SESSION['userEmail'];		}		if(!$_POST['quantity']) $_POST['quantity'] = 1;		if(!$_POST['duration']) $_POST['duration'] = 90;		$i = 0;		while ($i < 16) {			$temp = 'pic'.$i;			if($ad[$temp]) {				$temp = func(_mod.'imageuploader','getThumbnailImageName',$ad[$temp]);				//else $temp = '/images/icons/noimage.png';				$imagePreviews .= '<div style="width:100px; height:75px; float:left;"><span style="position:absolute; padding-left:5px; padding-top:2px; color:#FFFFFF;">'.($i+1).'</span><img name="previewImage'.$i.'" src="'.$temp.'" /></div>';			}			$i++;		}		setPageConst('title','Submit: Step 3 of 3!');		setPageConst('bct','<a href="/index">Home</a> > Sell: Step 3 of 3');		$typeSelect = '<select class="input" name="type" onMouseOver="setHelp(\'Type:\',\'<b>Select the type of your ad.</b><br /><br />Sale? Wanted? Lost? Found? Safarri can handle them all!\')" onMouseOut="clearHelp()">';		$rs = $_SERVER['db']->Execute("SELECT * FROM classifieds_types");		while ($arr = $rs->FetchRow()) {			if($_POST['type'] == $arr['typeId']) $selected = ' selected';			else $selected = '';			$typeSelect .= '<option value="'.$arr['typeId'].'"'.$selected.'>'.$arr['type'].'</option>';		}		$typeSelect .= '</select>';		$priceTypeSelect = '<select class="input" name="priceType" onMouseOver="setHelp(\'Price Type:\',\'<b>Select the price type of your ad.</b><br /><br />Coordinate it with the type (If your ad is a lost, the price type should probably be a reward).\')" onMouseOut="clearHelp()">';		$rs = $_SERVER['db']->Execute("SELECT * FROM classifieds_prices ORDER BY priceId");		while ($arr = $rs->FetchRow()) {			if($_POST['priceType'] == $arr['priceId']) $selected = ' selected';			else $selected = '';			$priceTypeSelect .= '<option value="'.$arr['priceId'].'"'.$selected.'>'.($arr['priceType'] ? $arr['priceType'] : 'Price Type (Optional):').'</option>';		}		$priceTypeSelect .= '</select>';		$expiresIn[$_POST['duration']] = 'checked';		//if(!isLoggedIn()) $loginRequired = '<em>(Registration Required)</em>';		if(!$message && $adminisEditing) $message = '<div class="nbox">Admin: You are now editing an anonymous ad created by another Safarri user.<br /><i>Certain fields which would only make sense for the original submitter have been hidden</i></div>';		setPageBlock('blockFancy',($_REQUEST['step'] == 'modify' ? 'Edit Your Ad' : 'Sell - Step 3 of 3'),'&nbsp;			<form enctype="multipart/form-data" method="post" action="/submit-id-'.$_REQUEST['id'].'-step-3-anonymous-true-edid-'.($adminisEditing ? '' : sha1($edidKey.$_REQUEST['id'])).'">			'.$message.'			'.($_REQUEST['step'] == 'modify' ? '<br /><input name="submit" type="submit" class="bold" value=">> Update Classified!" /><br />' : '').'			<table class="outer">			  <tr>				<th colspan="3">Classified Details:</th>			  </tr>			  '.($adminisEditing ? '' : '			  <tr>				<td class="lcol"><b>Type:</b>				<td class="rcol"><b>Anonymous</b></td>				<td class="dcol" style="width:300px;" align="center"><input class="button" name="submit" type="submit" value="Change Type to Registered" onMouseOver="setHelp(\'Type:\',\'<b>This button changes the item\\\'s type to registered.</b><br /><br />Registered classifieds give you more control, but require registration\')" onMouseOut="clearHelp()">'.$loginRequired.'</td>			  </tr>			  ').'			  <tr>				<td class="lcol"><b>Category:</b>				<td class="rcol"><b>'.func(_mod.'dbtree','getPathFromId','classifieds_categories',$_REQUEST['cat']).'</b></td>				<td class="dcol"><input class="button" name="submit" type="submit" value="Change Category" onMouseOver="setHelp(\'Category:\',\'<b>This button will let you select a different category for your ad.</b><br /><br />Use it if you thought of one that might be better!\')" onMouseOut="clearHelp()"></td>			  </tr>			  <tr>				<td class="lcol"><b>Expires In:</b>				<td colspan="2" class="rcol">				<input '.$expiresIn[3].' name="duration" type="radio" value="3" onMouseOver="setHelp(\'3 days:\',\'<b>This button sets your item\\\'s duration to three days.</b><br /><br />Three is a good choice for items which sell quickly.\')" onMouseOut="clearHelp()">				3 Days				<input '.$expiresIn[7].' name="duration" type="radio" value="7" onMouseOver="setHelp(\'7 days:\',\'<b>This button sets your item\\\'s duration to seven days.</b><br /><br />Seven is a good choice for the average item.\')" onMouseOut="clearHelp()">				7 Days				<input '.$expiresIn[14].' name="duration" type="radio" value="14" onMouseOver="setHelp(\'14 days:\',\'<b>This button sets your item\\\'s duration to fourteen days.</b><br /><br />Fourteen is a good choice for items that take longer to sell.\')" onMouseOut="clearHelp()">				14 Days				<input '.$expiresIn[21].' name="duration" type="radio" value="21" onMouseOver="setHelp(\'21 days:\',\'<b>This button sets your item\\\'s duration to twenty one days.</b><br /><br />Twenty one is a good choice for items that take really long to sell.\')" onMouseOut="clearHelp()">				21 Days				<input '.$expiresIn[90].' name="duration" type="radio" value="90" onMouseOver="setHelp(\'three months:\',\'<b>This button sets your item\\\'s duration to three months.</b><br /><br />While Safarri is getting started, we are offering the users the ability to run their ads for three months! This will ensure maximum exposure for your item.\')" onMouseOut="clearHelp()">				Three Months				<div class="desc">					Your ad will run for the amount of days that you specify, and then delete itself automatically.</div>				</td>			  </tr>			  <tr>				<th colspan="3">Item Details:</th>			  </tr>			    <tr>				  <td class="lcol"><b>Item Type:</b>				  <td class="rcol" colspan="2">'.$typeSelect.'</td>				</tr>				<tr>				  <td class="lcol">Item Price (US $):</td>				  <td class="rcol"><input class="input" name="price" type="text" id="price" value="'.number_format($_POST['price'],2).'" maxlength="20" onMouseOver="setHelp(\'Price:\',\'<b>Enter the price for your item in this field.</b><br /><br />You can select the item and price type in the drop boxes near.\')" onMouseOut="clearHelp()">				  <td class="rcol">'.$priceTypeSelect.'</td>				</td>			    <tr>				  <td class="lcol"><b>Ad Title:</b><br />				  <td class="rcol" colspan="2"><input class="input" name="title" type="text" id="title" value="'.$_POST['title'].'" maxlength="75" onMouseOver="setHelp(\'Title:\',\'<b>Enter the title of your ad in this field</b><br /><br />Try to provide buyers information they would be interested in with as few words as possible.\')" onMouseOut="clearHelp()"></td>				</tr>			    '.$itemDetails.'				<tr>                  <td class="lcol">Features:<div class="desc">(Each line creates<br />new bulleted item)</div></td>                  <td colspan="2" class="rcol"><textarea class="input" name="features" style="height:100px;" id="features" onMouseOver="setHelp(\'Features:\',\'<b>Your Item\\\'s key features go here.</b>eg. for a car:<br />&bull;Excellent tires<br />&bull;Am/Fm Sterio<br />&bull;Cruise Control<br /><br />Press enter between features, and they will be automatically bulleted\')" onMouseOut="clearHelp()">'.$_POST['features'].'</textarea></td>				</tr>				<tr>                  <td class="lcol">Description:                  <td colspan="2" class="rcol"><textarea class="input" name="description" style="height:200px;" id="description" onMouseOver="setHelp(\'Description:\',\'<b>Enter the description of your item in this field.</b><br /><br />Provide information that buyers would like to know such as the item\\\'s history, any damage, etc.\');" onMouseOut="clearHelp()">'.$_POST['description'].'</textarea></td>				</tr>  				<tr>					<td class="lcol">Images:<br /><div class="desc">(Press the "Browse" buttons<br />to select image files<br />on your computer)</div></td>					<td align="center" valign="top" class="rcol">						<script type="text/javascript">									function updatePreviewImage(num) {										image = document["previewImage"+num];										if(image) {											image.src = "/images/icons/noimageuploaded.png";											image.width = 100;											image.height = 75;										}										//document.getElementById("yourImagesWillBeUploaded").innerHTML="Press \">> Update Preview Images\" to see your images!";									}						</script>						<ol>						  <li>							<input class="upload" name="pic0" id="pic0" type="file" value="" onChange="updatePreviewImage(0);"  />						  </li>						  <li>							<input class="upload" name="pic1" id="pic1" type="file" value="" onChange="updatePreviewImage(1);" />						  </li>						  <li>							<input class="upload" name="pic2" id="pic2" type="file" value="" onChange="updatePreviewImage(2);" />						  </li>						  <li>							<input class="upload" name="pic3" id="pic3" type="file" value="" onChange="updatePreviewImage(3);" />						  </li>						  <li>							<input class="upload" name="pic4" id="pic4" type="file" value="" onChange="updatePreviewImage(4);" />						  </li>						  <li>							<input class="upload" name="pic5" id="pic5" type="file" value="" onChange="updatePreviewImage(5);" />						  </li>						  <li>							<input class="upload" name="pic6" id="pic6" type="file" value="" onChange="updatePreviewImage(6);" />						  </li>						  <li>							<input class="upload" name="pic7" id="pic7" type="file" value="" onChange="updatePreviewImage(7);" />						  </li>						  <li>							<input class="upload" name="pic8" id="pic8" type="file" value="" onChange="updatePreviewImage(8);" />						  </li>						  <li>							<input class="upload" name="pic9" id="pic9" type="file" value="" onChange="updatePreviewImage(9);" />						  </li>						  <li>							<input class="upload" name="pic10" id="pic10" type="file" value="" onChange="updatePreviewImage(10);" />						  </li>						  <li>							<input class="upload" name="pic11" id="pic11" type="file" value="" onChange="updatePreviewImage(11);" />						  </li>						  <li>							<input class="upload" name="pic12" id="pic12" type="file" value="" onChange="updatePreviewImage(12);" />						  </li>						  <li>							<input class="upload" name="pic13" id="pic13" type="file" value="" onChange="updatePreviewImage(13);" />						  </li>						  <li>							<input class="upload" name="pic14" id="pic14" type="file" value="" onChange="updatePreviewImage(14);" />						  </li>						  <li>							<input class="upload" name="pic15" id="pic15" type="file" value="" onChange="updatePreviewImage(15);" />						  </li>					  </ol>					  <input class="button" name="submit" type="submit" value="<< Clear All Images" onMouseOver="setHelp(\'Clear:\',\'<b>This button erases all the images for this ad.</b><br /><br />Only press it if you want it to start the image process over again!\')" onMouseOut="clearHelp()">					  <!--<input class="button" name="submit" type="submit" value=">> Update Preview Images" onMouseOver="setHelp(\'Update:\',\'<b>This button will update the preview images with the photos you have selected on the left</b><br /><br />Use it to make sure that your photos are correct.\')" onMouseOut="clearHelp()">-->					</td>					<td valign="top" class="rcol">'.$imagePreviews.'</td>				</tr>				<tr>				  <td class="lcol">Quantity:				  <td class="rcol"><input class="input" name="quantity" type="text" id="quantity" value="'.$_POST['quantity'].'" onMouseOver="setHelp(\'Quantity:\',\'<b>Enter the number of item(s) you have in this field.</b><br /><br />Safarri can handle inventory tracking for you!\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Change only if you have multiple items.</td>				</tr>				<tr>				  <th colspan="3">Item Location:</th>				</tr>			  	<tr>				  <td class="desc footer" colspan="3">If your item is located in the United States of America, enter it\'s <b>City and State</b> or <b>Zip Code</b> in the "Smart Location" field.<br />Enter any other location data such as <b>street</b> or <b>international addresses</b> in the Extra location field.</td>				</tr>				<tr>				  <td class="lcol">Smart Location:				  <td class="rcol"><input class="input" name="location" type="text" id="location" value="'.$_POST['location'].'" onMouseOver="setHelp(\'Location:\',\'<b>Enter the City and State or Zip Code of your item in this field.</b><br /><br />Providing a location enables buyers to browse local items, or calculate shipping from your location.\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Zip Code</td>			  </tr>			  <tr>				  <td class="lcol">Extra Location:				  <td class="rcol"><input class="input" name="extlocation" type="text" id="extlocation" value="'.$_POST['extlocation'].'" onMouseOver="setHelp(\'Location:\',\'<b>Enter any extra location information for your item in this field.</b><br /><br />It allows you to provide street level accuracy for real estate listings, or international locations not supported by the \\\'smart location\\\' geocoding engine.\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Street or International Address</td>			  </tr>			  <tr>				<th colspan="3">'.($adminisEditing ? 'Anonymous Seller\'s' : 'Your').' Details:</th>			  </tr>			  <tr>				<td class="lcol"><b>Phone Number:</b>				<td class="rcol"><input class="input" name="userPhone" type="text" id="userPhone" value="'.doPhone($_POST['userPhone']).'" onMouseOver="setHelp(\'Phone:\',\'<b>Enter your phone number in this field.</b><br /><br />The phone number is your only method of contact, so make sure it\\\'s correct.\');" onMouseOut="clearHelp()"></td>				<td class="dcol">Your phone number is necessary for buyers to contact you.</td>			  </tr>			  <tr>					<td class="lcol">Email Address:					<td class="rcol"><input class="input" name="userEmail" type="text" id="userName" value="'.$_POST['userEmail'].'" onMouseOver="setHelp(\'Email:\',\'<b>Enter your email address here.</b><br /><br /><div class=%22desc%22>If you enter your email address, Safarri will email you a link to edit this ad from any computer.<br />If you choose not to enter your email, you will be able to bookmark the ad page and edit the ad through the bookmark.</div><br /><br /><div class=%22btxt%22>Your email address is not required, and will not be shared with buyers or anyone else.</div>\')" onMouseOut="clearHelp()"></td>					<td class="dcol">'.( $user['userEmail'] ?							'You have been emailed an edit link to '.$user['userEmail'].'.<br />If you want another email sent, enter an email address again.' :							'Entering an email address will enable you to manage this ad from any computer.'						).'</td>				</tr>			  <tr>				<td class="lcol">Name:				<td class="rcol"><input class="input" name="userName" type="text" id="userName" value="'.$_POST['userName'].'" onMouseOver="setHelp(\'Name:\',\'<b>Enter your name in this field.</b><br /><br />Your name will help the ad to feel more personal.\')" onMouseOut="clearHelp()"></td>				<td class="dcol">Your name will help buyers contact you. (optional)</td>			  </tr>			  <tr>				<td class="lcol">Extra Info:				<td class="rcol"><input class="input" name="extraInfo" type="text" id="extraInfo" value="'.$_POST['extraInfo'].'" maxlength="50" onMouseOver="setHelp(\'Extra:\',\'<b>Enter extra info in this field.</b><br /><br />This might be instructions to call between a certain time, etc.\')" onMouseOut="clearHelp()"></td>				<td class="dcol">A field for your extra contact info. (optional)</td>			  </tr>			</table><br />			<input name="cat" type="hidden" id="cat" value="'.$_REQUEST['cat'].'">			<input name="submit" type="submit" class="bold" value=">> '.($_REQUEST['step'] == 'modify' ? 'Update' : 'Submit').' Classified!" onMouseOver="setHelp(\'Submit:\',\'<b>This button will submit your ad!</b><br /><br />Once you have double checked everything, press submit to instantly send your ad to the world!\')" onMouseOut="clearHelp()">			<br />			<div class="sub desc">				<div class="btxt laln">Notes:</div>				<ol style="margin-left:50px;">					<li>Please post ads in English</li>					<li>Ads which aren\'t legal, decent, or legitimate are subject to removal</li>					<li>Ad images may take a bit to upload once you press "Submit"</li>				</ol>				<div class="raln btxt">Thank You for Using Safarri!</div>			</div>		</form>		');		setPageBlock('blockHelp','Step 3 of 3:','<b>You are almost done!</b><br /><br />Please Describe your item in the fields to the right.<br /><br />I\'ll be here to give you tips as you go along.');	}	//*************************************************************************************	//*************************** Step 2 of 3, Select The Category! ****************************	//*************************************************************************************	else {		setPageConst('title','Submit: Step 2 of 3!');		setPageConst('bct','<a href="/index">Home</a> > Sell > Step 2 of 3');		setPage(		pFunc('blockFancy','Sell - Step 2 of 3','&nbsp;			<noscript>			<b>Your browser does not support javascript</b>			Javascript is needed to generate the category selection list.<br />			<em>Please enable JavaScript, or select a category using the browse interface:</em>			<ol>			<li>Click "Browse the Classifieds".</li>			<li>Navigate to the category of your choice <em>(must not be a top-level category)</em>.</li>			<li>Click the link titled <b>"QuickSubmit in Category"</b>, located in the <b>"Power User"</b> side box.</li>			</ol>			<h2><a href="/browse">>> Browse The Classifieds</a></h2><br /><br />			</noscript>			<div class="slender">				<div class="header">Select A Category for your Classified:</div>				<div class="content">				<script type="text/javascript"><!--					function catSubmit(cat) { window.location = "/submit-step-3-cat-" + cat + "-id-'.$_REQUEST['id'].'-edid-'.$_REQUEST['edid'].'-anonymous-true"; }				//--></script>				'.cfunc(300,_fnc.'categorytree','catTreeSelect').'				</div>				<div class="footer">Need another category? <a href="/contact">Please Suggest it!</a></div>			</div>			')		);		setPageBlock('blockHelp','Step 2 of 3:','<b>You are now submitting an anonymous classified!</b><br /><br />Please click on the category that best fits your item.');	}}//****************************************************************************************//******************************* The user is "Logged In" ********************************//****************************************************************************************else {	//Init	$purchaseMethodsInitial = 'Cash';	$purchaseMethodsArray = array( //Array used in purchase method selection, verification, and updates		'Cash'					=> false,		'Personal Check'		=> false,		'Cashier\'s Check'		=> false,		'Postal Money Order' 	=> false,		'Credit Card' 			=> true,		'Payment Processor' => array(			'PayPal','BidPay',		),	);	//****************************************************************************	//*********************** Step 3 of 3 of ad submission ***********************	//****************************************************************************	if($_REQUEST['step'] == 3 || $_REQUEST['step'] == 'modify') {		if($_REQUEST['edid']) $_SERVER['db']->execute('UPDATE classifieds_ads SET usid = \''.$_SESSION['userId'].'\' WHERE id = '.$_REQUEST['id']); //The user is turning their anonymous ad into a regular ad, and the user is not the admin editing some one else's ad		$ad = $_SERVER['db']->getRow("		SELECT * FROM classifieds_ads a, users u		WHERE a.id='{$_REQUEST['id']}' AND u.userId = a.usid");		if(!$ad['usid']) $ad['usid'] = $_SESSION['userId']; //We are first time submitter		if($ad) {  //they are modifying their classified			$ad['safarriPurchaseMethods'] = unserialize($ad['safarriPurchaseMethods']);			//if(!$ad['safarriPurchaseMethods']) $ad['safarriPurchaseMethods'] = array($purchaseMethodsInitial);		}		if($_POST['submit']) {			//************************ Handle Purchase Methods *****************			$temp = array(); 	//Reset Temp			$i = 0;				//Reset $i			foreach($purchaseMethodsArray as $key=>$val) {				$i++;				if(is_array($val)) {					$tempi = $i;					foreach($val as $name) {						$i++;						//if(!$_POST['pm'.$tempi.'link']) $_POST['pm'.$tempi.'link'] = (string) true;						if($_POST['pm'.$tempi] == 'pm'.$i) $temp[$name] = $_POST['pm'.$tempi.'link']; //Select Box					}				}				else {					//if(!$_POST['pm'.$i.'link']) $_POST['pm'.$i.'link'] = ''; //For some reason, it thinks it's an int...					if($_POST['pm'.$i]) $temp[$key] = $_POST['pm'.$i.'link']; //Checkbox				}			}			if($temp != $ad['safarriPurchaseMethods'] && !$adminisEditing) {				$ad['safarriPurchaseMethods'] = $temp;				$_SESSION['safarriPurchaseMethods'] = serialize($temp);			}			//************************ Proceed With Submission *****************			if($_POST['submit'] == '<< Clear All Images') {				$i = 0;				while ($i < 16) {					$temp1 = 'pic'.$i;					$ad[$temp1] = '';					$_FILES['pic'.$i] = '';					$i++;				}				$message = '<div class="ebox"><h3>Your Images were successfully cleared!</h3></div>';			}			else if($_POST['submit'] == '>> Update Preview Images') $message = '<div class="ebox"><h3>Your Images were successfully uploaded!</h3></div>';			else if($_POST['submit'] == 'Change Type to Anonymous' || $_POST['submit'] == 'Change Category') {}			else {				$weAreSubmitting = true;				if(!$_POST['title'])	$errors .= "<li>You forgot to enter the Title!</li>";				$_POST['price'] = preg_replace("/[^0-9\.]/","",$_POST['price']); //strip $ signs, etc...				if(!$_POST['type'])	$errors .= "<li>You didn't enter the type of listing!</li>";				if(!$_POST['cat'])		$errors .= "<li>You forgot to supply the category!</li>";				if(!$_POST['description'] && !$_POST['features'])	$errors .= "<li>Your item needs at least either a description or a list of features!</li>";				if($_POST['duration'] && $_POST['duration'] != 3 && $_POST['duration'] != 7 && $_POST['duration'] != 14 && $_POST['duration'] != 21) $errors .= "<li>The item's duration is out of range! Please select a valid duration.</li>";				if($_POST['submit'] != 'Ignore Possible Errors') {					if($_SESSION['userPhone'] && strlen($_SESSION['userPhone']) < 10) $notes .= "<li>Your phone number (".doPhone($_SESSION['userPhone']).") does not appear valid!</li>";				}			}			$i = 0;			$i2 = 0;			$i3 = 0;			while ($i < 16) {				$temp1 = 'pic'.$i2;				if($_FILES['pic'.$i]['size']) { //newly selected images overwrite					$i3++;					$image = func(_mod.'imageuploader','imageuploader','pic'.$i,400,300);					if($image == 1) 		$errors .= "<li>Image # {$i3}: you forgot to select an image file!<br /><em>(Please click the browse button)</em></li>";					else if($image == 2) 	$errors .= "<li>Image # {$i3}: the file you selected was not an image!<br /><em>(Please select a different file)</em></li>";					else if($image == 3) 	$errors .= "<li>Image # {$i3}: errors were experienced while processing your image!<br /><em>(Please try again)</em></li>";					else {						$ad[$temp1] = $image;					}				}				$i++;				if($ad[$temp1]) $i2++;			}			if($_POST['location']) {				$location = func(_mod.'location','getLocation',$_REQUEST['location']);				if(!$location) $errors .= "<li>Your Location could not be located!</li>";			}			if(!$errors && !$notes) {				if($_POST['features']) {					$lines = preg_split('`[\n\r]+`', trim($_POST['features']));					$_POST['features'] = '';					foreach($lines as $line) $_POST['features'] .= "<li>$line</li>" ;				}				/*$sql = "SELECT * FROM classifieds_catSpecifics WHERE cid=".$_REQUEST['cat']." AND type=dropDown";				$result = $_SERVER['db']->getAssoc($sql,false,true);				foreach ($result as $key=>$row) {					if(!$_POST[$row['title']]){						$errors .= "You forgot to enter the ".$row['title']."\n";					 }					 else {						//$details .= "$row[title]=$_POST[$row[title]],"; //create the two dimensional "details" array to insert into the database!					}				}*/				if(!$adminisEditing) { //This user is owner of this ad					/*$sql = "						UPDATE members SET						userPhone = '".undoPhone($_POST['userPhone'])."'						WHERE userId = '{$_SESSION['userId']}'						"; //, autoForwardEnabled = '".$_POST['autoforwardenabled']."'					$_SERVER['serverdb']->execute($sql);*/					$_SESSION['userPhone'] = undoPhone($_POST['userPhone']);				}				if($_REQUEST['step'] == 'modify' && $weAreSubmitting)	$ad['editDate'] = time();				if(!$ad['submitDate'] && $weAreSubmitting)				$ad['submitDate'] = time();				if(!($_POST['quantity'] > 1)) $_POST['quantity'] = 1; //is 0 or non-integer				$sql = '					REPLACE INTO classifieds_ads SET					id = '.dbStr($_REQUEST['id']).',					cid = '.dbStr($_REQUEST['cat']).',					title = '.dbStr(stripslashes($_POST['title'])).',					type = '.dbStr($_POST['type']).',					features = '.dbStr(stripslashes($_POST['features'])).',					description = '.dbStr(nl2br(stripslashes($_POST['description']))).',					price = '.dbStr($_POST['price']).',					priceType = '.dbStr($_POST['priceType']).',					usid = '.dbStr($ad['usid']).',					town = '.dbStr($location['city']).',					country = '.dbStr($location['state']).',					lat = '.dbStr($location['latitude']).',					lon = '.dbStr($location['longitude']).',					xtraLocation = '.dbStr($_POST['extlocation']).',					qty = '.dbStr($_POST['quantity']).',					anonymous_user_details = "",					pic0 = '.dbStr($ad['pic0']).',					pic1 = '.dbStr($ad['pic1']).',					pic2 = '.dbStr($ad['pic2']).',					pic3 = '.dbStr($ad['pic3']).',					pic4 = '.dbStr($ad['pic4']).',					pic5 = '.dbStr($ad['pic5']).',					pic6 = '.dbStr($ad['pic6']).',					pic7 = '.dbStr($ad['pic7']).',					pic8 = '.dbStr($ad['pic8']).',					pic9 = '.dbStr($ad['pic9']).',					pic10 = '.dbStr($ad['pic10']).',					pic11 = '.dbStr($ad['pic11']).',					pic12 = '.dbStr($ad['pic12']).',					pic13 = '.dbStr($ad['pic13']).',					pic14 = '.dbStr($ad['pic14']).',					pic15 = '.dbStr($ad['pic15']).',					thumb0 = '.dbStr(func(_mod.'imageuploader','getThumbnailImageName',$ad['pic0'])).',					view = '.dbStr($ad['view']).',					storeid = '.dbStr($_SESSION['safarriStore']['id']).',					duration = '.dbStr($_POST['duration']).',					date = '.dbStr(time()).',					submitDate = '.dbStr($ad['submitDate']).',					editDate = '.dbStr($ad['editDate']).',					soldDate = '.dbStr(($_POST['duration'] ? (time() + 60 * 60 * 24 * $_POST['duration']) : ($weAreSubmitting ? 0 : -1))).',					status = '.($ad['status'] ? $ad['status'] : 0).',					premier = '.($ad['premier'] ? $ad['premier'] : 0).'				';				$_SERVER['db']->execute($sql);				if(!$_REQUEST['id']) $_REQUEST['id'] = $_SERVER['db']->insert_id();				if(!$adminisEditing) $_REQUEST['edid'] = sha1($edidKey.$_REQUEST['id']); //Admin is not editing someone else's ad				if($_SERVER['db']->errorMsg()) {					$errors .= '<li>There were errors inserting your ad in the database. We apioligise for the inconvience. The tech support system has been notified, and we are working on fixing the problem.</li>';					mail('admin@safarri.com', 'Safarri Error: Database problem',					'Somebody got the create ad page to crash! The below database error:					'.$_SERVER['db']->errorMsg().'					was encountered with the below sql:					'.$sql);				}				if($_POST['submit'] == 'Change Type to Anonymous') 	redirect('/submit-id-'.$_REQUEST['id'].'-step-3-anonymous-true-edid-'.$_REQUEST['edid']);				if($_POST['submit'] == 'Change Category') 				redirect('/submit-id-'.$_REQUEST['id'].'-step-2');			} if($errors) {				$message = '<div class="ebox"><h3>Please Retry Your Submission:</h3><ul>'.$errors.'</ul></div>';			} else if($notes) {				$message = '<div class="nbox"><h3>There were possible errors with Your submission:</h3>				<ul>'.$notes.'</ul>				<b>Please either fix the errors and press submit again, or:</b><br /><br />				<div class="boldBorder"><input class="bold" name="submit" type="submit" value="Ignore Possible Errors"></div></div><br />';			}			else if($weAreSubmitting) redirect('/ad-'.$_REQUEST['id']);		//********* Yaay!!!!! ***********		}		if($ad) {  //they are modifying their classified			if(!$_POST) {				$_POST['title'] = $ad['title'];				$_POST['price'] = $ad['price'];				$_POST['type'] = $ad['type'];				$_POST['priceType'] = $ad['priceType'];				$_POST['description'] = $ad['description'];				$_POST['features'] = $ad['features'];				$_POST['quantity'] = $ad['qty'];				$_POST['duration'] = $ad['duration'];				if($ad['town']) $_POST['location'] = $ad['town'].' '.$ad['country'];				$_POST['extlocation'] = $ad['xtraLocation'];			}			$_POST['description'] = str_replace("<br />","",$_POST['description']);			$_POST['features'] = str_replace(array('<li>','</li>'),array('',"\n"),$_POST['features']);			if(!$_REQUEST['cat']) $_REQUEST['cat'] = $ad['cid']; //do not overwrite the category if they already have one!		}		if(!$_POST['location'] && $ad['usid'] == $_SESSION['userId']) $_POST['location'] = $_SESSION['userZip'];		if(!$_POST['quantity']) $_POST['quantity'] = 1;		$i = 0;		while ($i < 16) {			$temp = 'pic'.$i;			if($ad[$temp]) {				$temp = func(_mod.'imageuploader','getThumbnailImageName',$ad[$temp]);				//else $temp = '/images/icons/noimage.png';				$imagePreviews .= '<div style="width:100px; height:75pxpx; float:left;"><span style="position:absolute; padding-left:5px; padding-top:2px; color:#FFFFFF;">'.($i+1).'</span><img name="previewImage'.$i.'" src="'.$temp.'" /></div>';			}			$i++;		}		setPageConst('title','Submit: Step 3 of 3!');		setPageConst('bct','<a href="/index">Home</a> > Sell: Step 3 of 3');		$typeSelect = '		<script type="text/javascript"><!--		function doPriceTypes() {			type = document.getElementById("type").value;			price = document.getElementById("priceType").options;			if(type == "3") price["3"].selected = true; //Wanted - OBO			else if(type == "5") price["18"].selected = true; //Lost - Reward			else if(type == "6") price[""].selected = true; //Lost - Reward		}		--></script>		<select class="input" name="type" id="type" onChange="doPriceTypes();" onMouseOver="setHelp(\'Type:\',\'<b>Select the type of your ad.</b><br /><br />Sale? Wanted? Lost? Found? Safarri can handle them all!\')" onMouseOut="clearHelp()">		';		$rs = $_SERVER['db']->Execute("SELECT * FROM classifieds_types");		while ($arr = $rs->FetchRow()) {			if($_POST['type'] == $arr['typeId']) $selected = ' selected';			else $selected = '';			$typeSelect .= '<option value="'.$arr['typeId'].'"'.$selected.'>'.$arr['type'].'</option>';		}		$typeSelect .= '</select>';		$priceTypeSelect = '<select class="input" id="priceType" name="priceType" onMouseOver="setHelp(\'Price Type:\',\'<b>Select the price type of your ad.</b><br /><br />Coordinate it with the type (If your ad is a lost, the price type should probably be a reward).\')" onMouseOut="clearHelp()">';		$rs = $_SERVER['db']->Execute("SELECT * FROM classifieds_prices ORDER BY priceId");		while ($arr = $rs->FetchRow()) {			if($_POST['priceType'] == $arr['priceId']) $selected = ' selected';			else $selected = '';			$priceTypeSelect .= '<option value="'.$arr['priceId'].'"'.$selected.'>'.($arr['priceType'] ? $arr['priceType'] : 'Price Type (Optional):') 	.'</option>';		}		$priceTypeSelect .= '</select>';		$i = 0;	//Reset $i		foreach($purchaseMethodsArray as $key=>$val) {			$i++;			if($ad && ($ad['safarriPurchaseMethods'] && array_key_exists($key,$ad['safarriPurchaseMethods']))) $checked = ' checked';			else $checked = '';			if(!$val) {				$purchaseMethods .= '<input name="pm'.$i.'" type="checkbox"'.$checked.' /> '.$key.'<br clear="all" />';			}			else {				if(!is_array($val)) {					$purchaseMethods .= '<span style="float:right;">'.$key.' URL (optional): <input name="pm'.$i.'link" type="text" value="'.$ad['safarriPurchaseMethods'][$key].'" /></span>';					$purchaseMethods .= '<input name="pm'.$i.'" type="checkbox"'.$checked.' /> '.$key.'<br clear="all" />';				}				else {					$temp = '';					$tempName = 'pm'.$i;					foreach($val as $name) {						if($ad && ($ad['safarriPurchaseMethods'] && array_key_exists($name,$ad['safarriPurchaseMethods']))) {							$selected = ' selected';							$selName = $name;						}						else $selected = '';						$i++;						$temp .= '<option value="pm'.$i.'"'.$selected.'>'.$name.'</option>';					}					$purchaseMethods .= '<span style="float:right;">'.$key.' URL (optional): <input name="'.$tempName.'link" type="text" value="'.$ad['safarriPurchaseMethods'][$selName].'" /></span>';					$purchaseMethods .= '<select name="'.$tempName.'"><option value="">'.$key.':</option>'.$temp.'</select><br clear="all" />';				}			}		}		if($_SESSION['autoForwardEnabled']) $autoForwardY = ' checked';		else $autoForwardN = ' checked';		if(!$_POST['duration']) $_POST['duration'] = ''; //Switch 0 to true null		$expiresIn[$_POST['duration']] = 'checked';		if(!$message && $adminisEditing) $message = '<div class="nbox">Admin: You are now editing an ad created by another Safarri user.<br /><i>Certain fields which would only make sense for the original submitter have been hidden</i></div>';		setPageBlock('blockFancy', ($_REQUEST['step'] == 'modify' ? 'Edit Your Ad' : 'Sell - Step 3 of 3'), '			<form enctype="multipart/form-data" method="post" action="/submit-id-'.$_REQUEST['id'].'-step-3-edid-'.$_REQUEST['edid'].'">			'.$message.'			'.($_REQUEST['step'] == 'modify' ? '<br /><input name="submit" type="submit" class="bold" value=">> Update Classified!" /><br />' : '').'			<table class="outer">			  <tr>				<th colspan="3">Classified Details:</th>			  </tr>			  '.($adminisEditing ? '' : '			  <tr>				<td class="lcol"><b>Classified Type:</b>				<td class="rcol"><b>Registered</b></td>				<td class="dcol" style="width:300px;"><input class="button" name="submit" type="submit" value="Change Type to Anonymous" onMouseOver="setHelp(\'Anonymous:\',\'<b>This buttton will change your ad into an anonymous classified.</b><br /><br />Anonymous classifieds are easier because they do not require registration, but you have less control over them.\')" onMouseOut="clearHelp()"></td>			  </tr>			  ').'			  <tr>				<td class="lcol"><b>Category:</b>				<td class="rcol"><b>'.func(_mod.'dbtree','getPathFromId','classifieds_categories',$_REQUEST['cat']).'</b></td>				<td class="dcol"><input class="button" name="submit" type="submit" value="Change Category" onMouseOver="setHelp(\'Category:\',\'<b>This button will let you select a different category for your ad.</b><br /><br />Use it if you thought of one that might be better!\')" onMouseOut="clearHelp()"></td>			  </tr>			  <tr>				<td class="lcol"><b>Expires In:</b>				<td colspan="2" class="rcol">					<input '.$expiresIn[3].' name="duration" type="radio" value="3" onMouseOver="setHelp(\'3 days:\',\'<b>This button sets your item\\\'s duration to three days.</b><br /><br />Three is a good choice for items which sell quickly.\')" onMouseOut="clearHelp()">					3 days					<input '.$expiresIn[7].' name="duration" type="radio" value="7" onMouseOver="setHelp(\'7 days:\',\'<b>This button sets your item\\\'s duration to seven days.</b><br /><br />Seven is a good choice for the average item.\')" onMouseOut="clearHelp()">					7 days					<input '.$expiresIn[14].' name="duration" type="radio" value="14" onMouseOver="setHelp(\'14 days:\',\'<b>This button sets your item\\\'s duration to fourteen days.</b><br /><br />Fourteen is a good choice for items that take longer to sell.\')" onMouseOut="clearHelp()">					14  days					<input '.$expiresIn[21].' name="duration" type="radio" value="21" onMouseOver="setHelp(\'21 days:\',\'<b>This button sets your item\\\'s duration to twenty one days.</b><br /><br />twenty one is a good choice for items that take really long to sell.\')" onMouseOut="clearHelp()">					21 days					<input '.$expiresIn[''].' name="duration" type="radio" value="" onMouseOver="setHelp(\'Unlimited:\',\'<b>This button sets your item\\\'s duration to unlimited.</b><br /><br />You will be able to manually remove your item the instant it sells.\')" onMouseOut="clearHelp()">					Unlimited				</td>			  </tr>				<tr>				  <th colspan="3">Item Details:</th>				</tr>				<tr>				  <td class="lcol"><b>Item Type:</b>				  <td colspan="2" class="rcol">'.$typeSelect.'</td>				</tr>				<tr>				  <td class="lcol">Item Price (US $):</td>				  <td class="rcol"><input class="input" name="price" type="text" id="price" value="'.number_format($_POST['price'],2).'" maxlength="20" onMouseOver="setHelp(\'Price:\',\'<b>Enter the price for your item in this field.</b><br /><br />You can select the item and price type in the drop boxes near.\')" onMouseOut="clearHelp()">				  <td class="rcol">'.$priceTypeSelect.'</td>				</td>				<tr>				  <td class="lcol"><b>Ad Title:</b><br />				  <td colspan="2" class="rcol"><input class="input" name="title" type="text" id="title" value="'.$_POST['title'].'" maxlength="75" onMouseOver="setHelp(\'Title:\',\'<b>Enter the title of your ad in this field</b><br /><br />Try to provide buyers information they would be interested in with as few words as possible.\')" onMouseOut="clearHelp()"></td>				</tr>				'.$itemDetails.'				<tr>                  <td class="lcol">Features:<div class="desc">(Each line creates<br />new bulleted item)</div></td>                  <td colspan="2" class="rcol"><textarea class="input" style="height:100px;" name="features" id="features" onMouseOver="setHelp(\'Features:\',\'<b>Your Item\\\'s key features go here.</b>eg. for a car:<br />&bull;Excellent tires<br />&bull;Am/Fm Sterio<br />&bull;Cruise Control<br /><br />Press enter between features, and they will be automatically bulleted\')" onMouseOut="clearHelp()">'.$_POST['features'].'</textarea></td>				</tr>				<tr>                  <td class="lcol">Description:                  <td colspan="2" class="rcol"><textarea class="input" style="height:200px;" name="description" id="description" onMouseOver="setHelp(\'Description:\',\'<b>Enter the description of your item in this field.</b><br /><br />Provide information that buyers would like to know such as the item\\\'s history, any damage, etc.\');" onMouseOut="clearHelp()">'.$_POST['description'].'</textarea></td>				</tr>  				<tr>					<td class="lcol">Images:<br /><div class="desc">(Press the "Browse" buttons<br />to select image files<br />on your computer)</div></td>					<td align="center" valign="top" class="rcol">						<script type="text/javascript">									function updatePreviewImage(num) {										image = document["previewImage"+num];										if(image) {											image.src = "/images/icons/noimageuploaded.png";											image.width = 100;											image.height = 75;										}										//document.getElementById("yourImagesWillBeUploaded").innerHTML="Press \">> Update Preview Images\" to see your images!";									}						</script>						<ol>						  <li>							<input class="upload" name="pic0" id="pic0" type="file" value="" onChange="updatePreviewImage(0);"  />						  </li>						  <li>							<input class="upload" name="pic1" id="pic1" type="file" value="" onChange="updatePreviewImage(1);" />						  </li>						  <li>							<input class="upload" name="pic2" id="pic2" type="file" value="" onChange="updatePreviewImage(2);" />						  </li>						  <li>							<input class="upload" name="pic3" id="pic3" type="file" value="" onChange="updatePreviewImage(3);" />						  </li>						  <li>							<input class="upload" name="pic4" id="pic4" type="file" value="" onChange="updatePreviewImage(4);" />						  </li>						  <li>							<input class="upload" name="pic5" id="pic5" type="file" value="" onChange="updatePreviewImage(5);" />						  </li>						  <li>							<input class="upload" name="pic6" id="pic6" type="file" value="" onChange="updatePreviewImage(6);" />						  </li>						  <li>							<input class="upload" name="pic7" id="pic7" type="file" value="" onChange="updatePreviewImage(7);" />						  </li>						  <li>							<input class="upload" name="pic8" id="pic8" type="file" value="" onChange="updatePreviewImage(8);" />						  </li>						  <li>							<input class="upload" name="pic9" id="pic9" type="file" value="" onChange="updatePreviewImage(9);" />						  </li>						  <li>							<input class="upload" name="pic10" id="pic10" type="file" value="" onChange="updatePreviewImage(10);" />						  </li>						  <li>							<input class="upload" name="pic11" id="pic11" type="file" value="" onChange="updatePreviewImage(11);" />						  </li>						  <li>							<input class="upload" name="pic12" id="pic12" type="file" value="" onChange="updatePreviewImage(12);" />						  </li>						  <li>							<input class="upload" name="pic13" id="pic13" type="file" value="" onChange="updatePreviewImage(13);" />						  </li>						  <li>							<input class="upload" name="pic14" id="pic14" type="file" value="" onChange="updatePreviewImage(14);" />						  </li>						  <li>							<input class="upload" name="pic15" id="pic15" type="file" value="" onChange="updatePreviewImage(15);" />						  </li>					  </ol>					  <input class="button" name="submit" type="submit" value="<< Clear All Images" onMouseOver="setHelp(\'Clear:\',\'<b>This button erases all the images for this ad.</b><br /><br />Only press it if you want it to start the image process over again!\')" onMouseOut="clearHelp()">					  <!--<input class="button" name="submit" type="submit" value=">> Update Preview Images" onMouseOver="setHelp(\'Update:\',\'<b>This button will update the preview images with the photos you have selected on the left</b><br /><br />Use it to make sure that your photos are correct.\')" onMouseOut="clearHelp()">-->					</td>					<td valign="top" class="rcol">'.$imagePreviews.'</td>				</tr>				<tr>				  <td class="lcol">Quantity:				  <td class="rcol"><input class="input" name="quantity" type="text" id="quantity" value="'.$_POST['quantity'].'" onMouseOver="setHelp(\'Quantity:\',\'<b>Enter the number of item(s) you have in this field.</b><br /><br />Safarri can handle inventory tracking for you!\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Change only if you have multiple items.</td>				</tr>			  <tr>				  <th colspan="3">Item Location:</th>				</tr>			  	<tr>				  <td class="desc footer" colspan="3">If your item is located in the United States of America, enter it\'s <b>City and State</b> or <b>Zip Code</b> in the "Smart Location" field.<br />Enter any other location data such as <b>street</b> or <b>international addresses</b> in the Extra location field.</td>				</tr>				<tr>				  <td class="lcol">Smart Location:				  <td class="rcol"><input class="input" name="location" type="text" id="location" value="'.$_POST['location'].'" onMouseOver="setHelp(\'Location:\',\'<b>Enter the City and State or Zip Code of your item in this field.</b><br /><br />Providing a location enables buyers to browse local items, or calculate shipping from your location.\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Zip Code</td>			  </tr>			  <tr>				  <td class="lcol">Extra Location:				  <td class="rcol"><input class="input" name="extlocation" type="text" id="extlocation" value="'.$_POST['extlocation'].'" onMouseOver="setHelp(\'Location:\',\'<b>Enter any extra location information for your item in this field.</b><br /><br />It allows you to provide street level accuracy for real estate listings, or international locations not supported by the \"smart location\" geocoding engine.\')" onMouseOut="clearHelp()"></td>				  <td class="dcol">Street or International Address</td>			  </tr>				'.($adminisEditing ? '' : '				<tr>				  <th colspan="3">Your Details:</th>				</tr>				<!--<tr>				  <td colspan="3" class="desc">All fields in this section are optional, and will update your ATI Profile.</td>				</tr>-->				<tr>				  <td class="lcol">Your Phone Number:				  <td class="rcol"><input class="input" name="userPhone" type="text" id="userPhone" value="'.doPhone($_SESSION['userPhone']).'" maxlength="20" onMouseOver="setHelp(\'Phone:\',\'<b>Enter your phone number in this field.</b><br /><br />Phone numbers are an important method of contact, so make sure it\\\'s correct.\');" onMouseOut="clearHelp()"></td>				  <td class="dcol">Will update on all your ads</td>				</tr>				<!--<tr>				  <td class="lcol">Enable AutoForward:				  <td class="rcol" style="text-align:left;" onMouseOver="setHelp(\'AutoForward:\',\'<b>AutoForward automatically forwards your private messages to your email adress.</b><br /><br />You can enable it by selecting Yes, or disable it by selecting no.\');" onMouseOut="clearHelp()">				  <input name="autoforwardenabled" type="radio" value="1"'.$autoForwardY.'>Yes				  <input name="autoforwardenabled" type="radio" value=""'.$autoForwardN.'> No				  </td>				  <td class="dcol">Forwards Private Messages to your email address.</td>				</tr>				<tr>				  <td class="lcol">Purchase Methods:<br /><br />(Optional)<br /><br /><em>Check all that apply</em>				  <td colspan="2" style="text-align:left;" class="dcol" onMouseOver="setHelp(\'Purchase:\',\'<b>Purchase Methods tell buyers how they will need to pay for your items.</b><br /><br />Please Check all that you would consider using.\');" onMouseOut="clearHelp()">				  '.$purchaseMethods.'				  </td>				</tr>-->				').'			</table>			<br />			<input class="input" name="cat" type="hidden" id="cat" value="'.$_REQUEST['cat'].'">			<input name="submit" type="submit" class="bold" value=">> '.($_REQUEST['step'] == 'modify' ? 'Update' : 'Submit').' Classified!" onMouseOver="setHelp(\'Submit:\',\'<b>This button will submit your ad!</b><br /><br />Once you have double checked everything, press submit to instantly send your ad to the world!\')" onMouseOut="clearHelp()">			<br />			<div class="sub desc">				<div class="btxt laln">Notes:</div>				<ol>					<li>Please post ads in English</li>					<li>Ads which aren\'t legal, decent, or legitimate are subject to removal</li>					<li>Ad images may take a bit to upload once you press "Submit"</li>				</ol>				<div class="raln btxt">Thank You for Using Safarri!</div>			</div>		</form>		');		setPageBlock('blockHelp','Step 3 of 3:','<b>You are almost done!</b><br /><br />Please Describe your item in the fields to the right.<br /><br />I\'ll be here to give you tips as you go along.');	}	//*************************************************************************************	//****************************** Step 2 of 3, Select The Category! *************************	//*************************************************************************************	else {		setPageConst('title','Submit: Step 2 of 3!');		setPageConst('bct','<a href="/index">Home</a> > Sell: Step 2 of 3');		setPage(		pFunc('blockFancy','Sell - Step 2 of 3','&nbsp;			<noscript>			<b>Your browser does not support javascript</b>			Javascript is needed to generate the category selection list.<br />			<em>Please enable JavaScript, or select a category using the browse interface:</em>			<ol>			<li>Click "Browse the Classifieds".</li>			<li>Navigate to the category of your choice <em>(must not be a top-level category)</em>.</li>			<li>Click the link titled <b>"QuickSubmit in Category"</b>, located in the <b>"Power User"</b> side box.</li>			</ol>			<h2><a href="/browse">>> Browse The Classifieds</a></h2><br /><br />			</noscript>			<div class="slender">				<div class="header">Select A Category for your Classified:</div>				<div class="content">					<script type="text/javascript"><!--						function catSubmit(cat) { window.location = "/submit-step-3-cat-" + cat + "-id-'.$_REQUEST['id'].'"; }					//--></script>					'.cfunc(300,_fnc.'categorytree','catTreeSelect').'				</div>				<div class="footer">Need another category? <a href="/contact">Please Suggest it!</a></div>			</div>		'));		setPageBlock('blockHelp','Step 2 of 3:','<b>You are now submitting a registered classified!</b><br /><br />Please click on the category that best fits your item.');	}}?>