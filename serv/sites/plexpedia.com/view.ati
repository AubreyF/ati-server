<?if($_REQUEST['default']) $_REQUEST['id'] = $_REQUEST['default'];//***************************************************************************//*****************************  Section 1  **********************************//************** Handle request and set initial variables ********************//***************************************************************************$item = $_SERVER['db']->getRow("SELECT * FROM `forum_threads` WHERE `id` = '{$_REQUEST['id']}'");if(!$item) redirect('/browse','We could not locate the item you wanted to view:<br />'.$_SERVER['db']->errorMsg());if($item['access'] == 2 && $item['groupId'] != $_SESSION['plexpediaGroup']['id']) redirect('/index','Sorry, but you did not have permission to view that item.');$item['submitTime'] = doDate($item['submitTime'],'short');if($item['groupId'] && $item['groupId'] > -1 && $item['groupId'] != $_SESSION['plexpediaGroup']['id']) {	//if(!$item['groupId']) $group = array('link'=>'plexpedia.com','name'=>'PlexPedia');	//else 	$group = $_SERVER['db']->getRow('select name, link, access from groups where id = '.$item['groupId']);		if(!strpos($group['link'],'.')) $group['link'] .= '.plexpedia.com';		$categoryTree = $group['name'].' > ';	$linkedCategoryTree = '<a href="http://'.$group['link'].'">'.$group['name'].'</a> > ';}$category = $_SERVER['db']->getRow('SELECT * FROM '.($item['groupId'] ? 'group' : 'forum').'_categories'.' WHERE id = '.$item['cid']);$temp = func(_mod.'dbtree','getLinkedPathFromId',($item['groupId'] ? 'group' : 'forum').'_categories',$category['id'], '/browse','cat');if(strpos($_SESSION['lastPage'],'/browse')) $linkedCategoryTree .= '<a href="'.$_SESSION['lastPage'].'">'.$_SESSION['plexpediaGroup']['text']['contentName'].'</a>'.($temp != '' ? ' > '.$temp : '');else $linkedCategoryTree .= '<a href="/browse">'.$_SESSION['plexpediaGroup']['text']['contentName'].'</a>'.($temp != '' ? ' > '.$temp : '');$categoryTree .= func(_mod.'dbtree','getPathFromId',($item['groupId'] ? 'group' : 'forum').'_categories',$category['id']);$user = renderMemberBasic($item['userId']);$_SERVER['db']->execute("UPDATE `forum_threads` SET `views`=`views`+'1' WHERE `id` = '{$_REQUEST['id']}'"); //update this item's views!if(isLoggedIn()) dbPut('site','forum_reads',array('readUser'=>$_SESSION['userId'], 'threadId'=> $item['id'], 'readTime'=>time()));$item['views'] += 1; //First time viewers don't want to see 0...$item['typeName'] = $_SERVER['plexDataTypes'][$item['type']]['n'];//if(!$item['typeName']) redirect('/browse');if(!$item['groupId'] || ($item['groupId'] == $_SESSION['plexpediaGroup']['id'] && $_SESSION['plexpediaGroup']['userCanComment']) || $group['access'] == 1 || $group['access'] == 4) $_SESSION['plexpediaGroup']['userMayComment'] = true;else $_SESSION['plexpediaGroup']['userMayComment'] = false;if(isAdmin() || ($item['groupId'] == $_SESSION['plexpediaGroup']['id'] && isModerator())) $_SESSION['plexpediaGroup']['userMayModerate'] = true;else $_SESSION['plexpediaGroup']['userMayModerate'] = false;/*test($item['groupId']);test($_SESSION['plexpediaGroup']['id']);test($_SESSION['plexpediaGroup']['userMayModerate']);*///***************************************************************************//*****************************  Section 2  **********************************//*************************** Set Page Contents ******************************//***************************************************************************setPageConst('title', /*($item['type'] != 'bug'  ? $item['typeName'].': ' : '').$categoryTree.' > '.*/strip_tags($item['title']));setPagePref('navCurrent', '/browse'); //"A Tab Must Always Be Selected!" ~ Pa :-)//***************************************************************************//*****************************  Section 3  **********************************//**************************** Handle Comments *******************************//***************************************************************************if($item['type'] != 'dat' && $item['type'] != 'pge') {	if($_SERVER['db']->getOne('SELECT COUNT(*) FROM forum_posts WHERE tid = '.$item['id']) > 100) $flatOverride = true;	$GLOBALS['replies'] = 0;	$item['replies'] = 0;		$GLOBALS['commentFilterSQL'] = (!isAdmin() && !isModerator() ? ' AND (state="active"'.($_REQUEST['c'] ? ' OR id = '.dbInt($_REQUEST['c']) : '').')' : '');		//****************** Threaded view mode ***********************		if ($_REQUEST['c'] || ($_SESSION['forumViewMode'] == 'threaded' && !$flatOverride)) {		function listComments($sel_id=0) {			$sql = "SELECT id,title,date,state,userId FROM forum_posts WHERE pid=".$sel_id." AND tid=".$_REQUEST['id'].$GLOBALS['commentFilterSQL']." ORDER BY date ASC";			$rs = $_SERVER['db']->execute($sql);			if($rs) {				while ($post = $rs->FetchRow()) {					$GLOBALS['replies'] += 1;					$post['user'] = renderMemberBasic($post['userId']);					if($post['id']==$_REQUEST['c']) {						$post = $_SERVER['db']->getRow("SELECT * FROM forum_posts WHERE id=".$_REQUEST['c']);						$post['parentLink'] = ($post['pid'] ? (do_url('c',$post['pid']).'#c'.$post['pid']) : '');						$post['links']['Close'] = '/view-id-'.$_REQUEST['id'].'#comments';						if($_SESSION['plexpediaGroup']['userMayComment']) $post['links']['Reply to Comment'] = '/submitpost-tid-'.$_REQUEST['id'].'-pid-'.$post['id'];						if($_SESSION['userId'] == $post	['userId'] || isAdmin()) $post['links']['Edit'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'];						if($_SESSION['plexpediaGroup']['userMayModerate']) {							if($post['state'] == 'active') $post['links']['Hide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-removed';							else $post['links']['Unhide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-active';						}						$posts .= '<a name="comment" class="anchor"></a>'.pfunc('blockComment',$post);					}					else $posts .= '<li><span style="float:right;" class="desc">(by '.$post['user']['userName'].' on '.doDate($post['date'],'short').')</span><a title="'.$post['title'].'" href="/view-id-'.$_REQUEST['id'].'-c-'.$post['id'].'#comment">'.$post['title'].'</a></li>';					$posts .= listComments($post['id'],$prefix." > ");				}				return '<ol class="llst">'.$posts.'</ol>';			}		}		$comments = listComments();		$item['replies'] = $GLOBALS['replies'];	}		//************* Build standard, flat old non threaded view ****************		else if ($_SESSION['forumViewMode'] == 'flat' || $flatOverride){ 						$sql = "SELECT * FROM forum_posts WHERE tid = '{$_REQUEST['id']}'".$GLOBALS['commentFilterSQL']." ORDER BY date ASC";		$rs = $_SERVER['db']->execute($sql);		if($rs) {			while ($post = $rs->FetchRow()) { //Foreach post in thread				$post['parentLink'] = ($post['pid'] ? '#c'.$post['pid']: '');				if($_SESSION['plexpediaGroup']['userMayComment']) $post['links']['Reply to Comment'] = '/submitpost-tid-'.$_REQUEST['id'].'-pid-'.$post['id'];				if($_SESSION['userId'] == $post['userId'] || isAdmin()) $post['links']['Edit'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'];				if($_SESSION['plexpediaGroup']['userMayModerate']) {					if($post['state'] == 'active') $post['links']['Hide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-removed';					else $post['links']['Unhide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-active';				}				$comments .= '<a name="c'.$post['id'].'" class="anchor"></a>'.pfunc('blockComment',$post);				$item['replies'] += 1;			}		}			}		//************** Hybrid - The Default Comment View Mode ********************		else {		function listComments($sel_id = 0, $depth = 0) {			$sql = "SELECT * FROM forum_posts WHERE pid=".$sel_id." AND tid=".$_REQUEST['id'].$GLOBALS['commentFilterSQL']." ORDER BY date ASC";			$rs = $_SERVER['db']->execute($sql);			if($rs) {				while ($post = $rs->FetchRow()) {					$post['parentLink'] = ($post['pid'] ? '#c'.$post['pid']: '');					if($_SESSION['plexpediaGroup']['userMayComment']) $post['links']['Reply to Comment'] = '/submitpost-tid-'.$_REQUEST['id'].'-pid-'.$post['id'];					if($_SESSION['userId'] == $post['userId'] || isAdmin()) $post['links']['Edit'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'];					if($_SESSION['plexpediaGroup']['userMayModerate']) {						if($post['state'] == 'active') $post['links']['Hide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-removed';						else $post['links']['Unhide'] = '/submitpost-id-'.$post['id'].'-tid-'.$_REQUEST['id'].'-setstate-active';					}					$posts .= '<a name="c'.$post['id'].'" class="anchor"></a>'.pfunc('blockComment',$post);					$posts .= listComments($post['id'], $depth + 1);					$GLOBALS['replies'] += 1;				}								if(!$sel_id) return $posts;				return '<div style="padding-left:'.(max(2,(15 - $depth * 1.2))).'px; border-left:1px dashed #F1F1F1;" class="subpost">'.$posts.'</div>';			}		}				$comments = listComments();		$item['replies'] = $GLOBALS['replies'];	}}$lbar = (($item['userId'] == $_SESSION['userId'] && $item['state'] != 'removed' && $item['state'] != 'memoryhole') || isAdmin() || (isModerator() && $item['groupId'] == $_SESSION['plexpediaGroup']['id']) ? '<div class="lbar">			<span style="float:left; line-height:10px;">				Status:				<form style="display:inline;">					<select id="setstate" name="state" class="input" style="display:inline;">						<option>Active</option>'./*($item['type'] == 'dis' || $item['type'] == 'bug' ? */'						<option'.($item['state'] == 'resolved' ? ' selected' : '').'>Resolved</option>'/*: '')*/.'						<option'.($item['state'] == 'hidden' ? ' selected' : '').'>Hidden</option>						'.(isAdmin() || isModerator() || $item['state'] == 'sticky' ? '						<option'.($item['state'] == 'sticky' ? ' selected' : '').'>Sticky</option>						' : '').'						'.(isAdmin() || isModerator() ? '						<option'.($item['state'] == 'removed' ? ' selected' : '').'>Removed</option>						' : '').'						'.(isAdmin() ? '						<option'.($item['state'] == 'memoryhole' ? 'memoryhole' : '').'>"Memory Hole"</option>						' : '').'					</select>				</form>				<script type="text/javascript">					$(\'setstate\').addEvent(\'change\',function(){document.location=\'/submit-id-'.$item['id'].'-setstate-\' + $(\'setstate\').value;});				</script>				'.(isAdmin() || isModerator() ? '				Category:				<form style="display:inline;">					<select id="setcat" name="cat" class="input" style="display:inline;">						'.func(_fnc.'categorylist','categoryOptions',$item['cid']).'					</select>				</form>				<script type="text/javascript">					$(\'setcat\').addEvent(\'change\',function(){document.location=\'/submit-id-'.$item['id'].'-rdr-true-setcat-\' + $(\'setcat\').value;});				</script>				' : '').'			</span>			'.(isAdmin() || $item['userId'] == $_SESSION['userId'] ? '<span style="float:right;"><a href="/submit-id-'.$_REQUEST['id'].'">» Edit '.$item['typeName'].'</a></span>' : '').'			&nbsp;			</div>' : '');//***************************************************************************//*****************************  Section 4  **********************************//**************************** Render PAGE!!! ********************************//***************************************************************************//<a href="#email" style="float:right;"><img src="/tpl/pc/img/itemviewtitlebuttonemail.png" alt="Email This!" width="50" height="35"></a><a href="'.do_url('tpl','print').'" style="float:right;"><img src="/tpl/pc/img/itemviewtitlebuttonprint.png" alt="Print This!" width="50" height="35"></a>setPageConst('bct','<a href="/index">Home</a>'.($linkedCategoryTree ? ' > '.$linkedCategoryTree : '').' > '.$item['typeName'].': '.strip_tags($item['title']));if($item['type'] == 'pge' || $item['type'] == 'dat') {	setPage(		$item['text'].'<br /><br />'.$lbar	);}else {		setPageBlock('blockHeaded',strip_tags($item['title']),'		<span class="rflt" style="padding-left: 20px;"><b>'.$item['replies'].'</b> Comments - <b>'.$item['views'].'</b> Views</span>		<div class="laln btxt">'.$item['description'].'</div>		<span style="padding-left: 20px;" class="rflt">Submitted By <b>'.$user['userName'].'</b> on <b>'.$item['submitTime'].'</b></span>		<div class="laln">'.strip_tags(str_replace(';',', ',$item['tags'])).'&nbsp;</div>		<!--<br clear="all" />-->		'.($item['groupId'] != $_SESSION['plexpediaGroup']['id'] ? '<a href="http://'.$group['link'].'/view-'.$item['id'].'" class="lbtn bold" style="margin:5px;" target="_blank">This '.$item['typeName'].' originally posted in the "'.$group['name'].'" Group</a>' : '').'	',$lbar.'<br />');		if($item['type'] == 'pic') {		setPage('<img src="'.$item['text'].'" alt="'.$item['description'].'" style="margin:auto; display:block;" class="imgx" /><br />');	}	else if($item['type'] == 'lnk') {		setPage('<a href="'.$item['text'].'" title="'.$item['description'].'" class="htxt caln" style="display:block; padding:30px; padding-bottom:50px;">» '.strip_tags($item['title']).'<a>');	}	else if($item['type'] == 'aud') {		setPage('			<div class="caln">			<br />			<object width="400" height="40" type="application/x-shockwave-flash" data="http://flash-mp3-player.net/medias/player_mp3_maxi.swf">				<param name="movie" value="http://flash-mp3-player.net/medias/player_mp3_maxi.swf" />				<param name="bgcolor" value="#ffffff" />				<param name="FlashVars" value="mp3='.urlencode($item['text']).'&amp;width=400&amp;volume=200&amp;height=40&amp;autoplay=1&amp;showvolume=1&amp;showloading=always&amp;buttonwidth=30" />			</object>			<br /><br /><a href="'.$item['text'].'" target="_blank" class="stxt" title="'.$item['description'].'" >» Right Click This Link to Download Audio File</a><br /><br /><br />			</div>		');	}	else {		setPage('			'.($item['state'] == 'hidden' ? '<div class="ebox">This '.$item['typeName'].' is "Hidden" - meaning it will not show in the browse system.<br />Change the status to "Active" when ready for primetime!</div>' : '').'			<div class="artText">				<p>'.$item['text'].'</p>				<div style="text-align:right;">					<img src="'.($item['picture'] ? $item['picture'] : '/img/icon'.$item['type'].'.png').'" style="margin:10px;" />				</div>			</div>		');	}		$linkBar[$_SESSION['forumViewMode']] = ' class="down"';		if($comments) {		$lbar = '		<div class="lbar">			'.(!$_SESSION['plexpediaGroup']['userMayComment'] ? '' : '<span style="float:right;"><a href="/submitpost-tid-'.$item['id'].'" class="boldText">» '.($item['type'] == 'dis' ? 'Reply to ' : 'Comment on ').$item['typeName'].'</a></span>').'			<span style="float:left;">                                                                                                                                                                 				'.($flatOverride ? '(Too Many Replies for Fancy Display)' : '<a href="/setview-mode-threaded"'.$linkBar['threaded'].'>Threaded</a>  <a href="/setview"'.$linkBar[''].'>Hybrid</a> <a href="/setview-mode-flat"'.$linkBar['flat'].'>Flat</a>').'			</span>			<b>'.$item['replies'].' '.($item['type'] == 'dis' ? 'Replies' : 'Comments').'</b>		</div>';		setPage('<a name="comments"></a>'.$lbar.$comments.'<br />'.$lbar);	}	else if($_SESSION['plexpediaGroup']['userMayComment']) setPage('		<a name="comments"></a>		<div class="header">No '.($item['type'] == 'dis' ? 'Replies' : 'Comments').' Yet</div>		<a href="/submitpost-tid-'.$item['id'].'" class="lbtn bold">Post a '.($item['type'] == 'dis' ? 'Reply' : 'Comment').'</a>	');}/*setPageBlock('blockHeaded','<a name="email"></a>Email This To A Friend!','	<form method="post">			</form>');*/setPage('<link rel="alternate" type="application/rss+xml" title="Latest comments on this thread" href="http://'.$_SERVER['HTTP_HOST'].'/comments.atis-tpl-rss-tid-'.$_REQUEST['id'].'" />','head');?>