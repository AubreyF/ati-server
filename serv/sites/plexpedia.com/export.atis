<?$types = array(	'nws' => 'News',	'art' => 'Article',	'dat' => 'Data Fact',	'deb' => 'Debate',	'dis' => 'Discussion',	'bug' => 'Bug',);//Groups$temp = '';if($_SERVER['FAKE_HOST_TOP'] != PLEXPEDIA) $temp = $_SERVER['HTTP_HOST']; //Custom Domainelse if($_SERVER['HTTP_HOST_SUB']) $temp = $_SERVER['HTTP_HOST_SUB']; //Plexpedia Subdomainif($temp) { //Were on a group	$_SESSION['plexpediaGroup'] = $_SERVER['db']->getRow("SELECT * FROM `groups` WHERE `link` = '{$temp}'");	if($_SESSION['plexpediaGroup']) {		if($_SESSION['plexpediaGroup']['type'] == 'usr') {			$_SESSION['plexpediaGroup']['sql'] = ' AND userId = \''.$_SESSION['plexpediaGroup']['usId'].'\'';		}		else {			$_SESSION['plexpediaGroup']['sql'] = " AND (`groupid` = '{$_SESSION['plexpediaGroup']['id']}'";			if($_SESSION['plexpediaGroup']['catgroups']) {				if(strpos($_SESSION['plexpediaGroup']['catgroups'],',')) {					$_SESSION['plexpediaGroup']['catgroups'] = explode($_SESSION['plexpediaGroup']['catgroups'],',');					foreach($_SESSION['plexpediaGroup']['catgroups'] as $key=>$val) $_SESSION['plexpediaGroup']['sql'] .= ' OR groupid = \'-'.$val.'\'';				}				else $_SESSION['plexpediaGroup']['sql'] .= ' OR groupid = \'-'.$_SESSION['plexpediaGroup']['catgroups'].'\'';			}			$_SESSION['plexpediaGroup']['sql'] .= ')';		}		$_SESSION['groupName'] = $_SESSION['plexpediaGroup']['name'];		define('catTable', 'group_categories');	}		if($_SESSION['plexpediaGroup']['access'] == '3') {		if(!isLoggedIn()) {			if(!strpos($_SERVER['FAKE_URI'],'/user/login')) redirect('/user/login','This is an "Invite Only" group. If you have an invitation, please login!');		} else if($_SESSION['plexpediaGroup']['usId'] != $_SESSION['userId'] && !isAdmin() && !$_SERVER['db']->getOne('SELECT groupId FROM group_members WHERE userId = "'.$_SESSION['userId'].'" AND groupId = "'.$_SESSION['plexpediaGroup']['id'].'"')) {			if(!strpos($_SERVER['FAKE_URI'],'/user/logout') && !strpos($_SERVER['FAKE_URI'],'/nopermission')) redirect('/nopermission');		}	}}if(!$_SESSION['plexpediaGroup']['sql']) $_SESSION['plexpediaGroup']['sql'] = " AND `groupid` = ''";if(!$_SESSION['groupName']) define('catTable', 'forum_categories');if(!$_REQUEST['ppage']) $_REQUEST['ppage'] = 25;//Type Specific Categoriesif($_SESSION['groupName']) $bugCat = $_SERVER['db']->getRow('SELECT * FROM group_categories WHERE type = \'bug\''.$_SESSION['plexpediaGroup']['sql']);//Misc init...if($_REQUEST['cat']) $category = $_SERVER['db']->getRow('SELECT * FROM '.catTable.' WHERE id = '.$_REQUEST['cat']);//Show Modeif($_REQUEST['show'] == 'all') $_REQUEST['show'] = '';if($_REQUEST['show'] == 'nws') {	$threadBox['type'] = 'News';} else if($_REQUEST['show'] == 'art') {	$threadBox['type'] = 'Article';} else if($_REQUEST['show'] == 'dat') {	$threadBox['type'] = 'Data Fact';} else if($_REQUEST['show'] == 'deb') {	$threadBox['type'] = 'Debate';} else if($_REQUEST['show'] == 'dis') {	$threadBox['type'] = 'Discussion';} else if($bugCat && $_REQUEST['show'] == 'bug' && ($_REQUEST['show'] == 'bug' || $category['type'] == 'bug')) {	//if(!$_REQUEST['cat']) redirect('/export-cat-'.$bugCat['id']);	$threadBox['type'] = 'Bug';} else {	$threadBox['type'] = 'All';}//Misc Sql$threadBox['sql']['where'][] = "(`state` = 'active' OR `state` = 'resolved')";if($_REQUEST['show']) $threadBox['sql']['where'][] = "`type` = '{$_REQUEST['show']}'";//Order byif($_REQUEST['order']) {	if ($_REQUEST['order'] == 'dateOld')		$threadBox['extra'] .= ' ORDER BY date ASC';	else if ($_REQUEST['order'] == 'dateNew')	$threadBox['extra'] .= ' ORDER BY date DESC';	else 										$threadBox['extra'] .= ' ORDER BY title ASC';}else 	$threadBox['extra'] .= " ORDER BY `state` ASC, `time` DESC";//Generate Page Title and data$page['title'] = ucwords($_SERVER['HTTP_HOST']).' - '.$threadBox['type'];if($_REQUEST['mode'] == 3) $page['title'] .= ' Replies to Me';if($_REQUEST['mode'] == 2) $page['title'] .= ' Posts and Replies';//Inside Categoryif($category['id']) {	if($category['access'] == '3') {		exit;	}	if($childCategories = func(_mod.'dbtree','getAllChildren',catTable,$_REQUEST['cat'])) foreach($childCategories as $key=>$id) {		$subCategories .= " || (`cid` = '{$id}')";	}	$threadBox['sql']['where'][] = "((`cid` = '{$_REQUEST['cat']}'){$subCategories})";		$page['title'] .= ' > '.func(_mod.'dbtree','getPathFromId',catTable,$_REQUEST['cat']);}else $_REQUEST['cat'] = 0;//Doing boolean searchif($_REQUEST['all'] || $_REQUEST['none'] || $_REQUEST['any']) {		$_REQUEST['searchString'] = '';		if($_REQUEST['all'])  $_REQUEST['searchString'] .= '+('.$_REQUEST['all'].')';		if($_REQUEST['none']) $_REQUEST['searchString'] .= ' -('.$_REQUEST['none'].')';		if($_REQUEST['any'])  $_REQUEST['searchString'] .= ' '.$_REQUEST['any'];}//Doing simple searchelse {	$_REQUEST['searchString'] = $_REQUEST['search'];	$_POST['any'] = $_REQUEST['search'];}//Doing a searchif($_REQUEST['searchString']) {	$threadBox['sql']['where'][] = "MATCH(title,description) AGAINST ('{$_REQUEST['searchString']}' IN BOOLEAN MODE)";	$page['title'] .= ' > Search : '.$_REQUEST['searchString'];}//Doing a searchelse if($_REQUEST['tag']) {	$threadBox['sql']['where'][] = 'tags LIKE '.dbstr('%'.$_REQUEST['tag'].'%');	$page['title'] .= ' > Tag : '.$_REQUEST['tag'];	$page['bct'] .= ' > Tag : '.$_REQUEST['tag'];}//Organize SQL$items = 0;//Modes:// 1) All Content Items// 2) All Items and Replies// 3) All Replies to me//************* Do Topics **************if($_REQUEST['mode'] != 3) {	$where = '';	foreach ($threadBox['sql']['where'] as $key => $value) if($value) $where .= ($where ? ' AND ' : ' WHERE ').$value;	//$threadBox['sql']['order'] = " ORDER BY `submitTime` DESC";	$sql = "SELECT `id`, `title`, `type`, `description`, `state`, `userId`, `views`, `picture`, `text`, `submitTime` FROM `forum_threads` ".$where." {$_SESSION['plexpediaGroup']['sql']}{$_SESSION['plexpediaGroup']['sqlContent']} {$threadBox['extra']}";	//die($sql);	if(!$rs = $_SERVER['db']->execute($sql)) error('The database is experiencing errors.','fatal');	if($items += $rs->RecordCount()) {		$page['pagination'] = func(_mod.'pagination','pagination',$items,$_REQUEST['ppage']);		if($items > $_REQUEST['ppage']) {			$sql .= " LIMIT {$page['pagination']['offset']},{$page['pagination']['limit']}";			$rs = $_SERVER['db']->execute($sql);		}		while ($thread = $rs->FetchRow()) {			$thread['link'] = 'http://'.$_SERVER['HTTP_HOST'].'/view-'.$thread['id'];			$thread['type'] = $types[$thread['type']];			$thread['time'] = $thread['submitTime'];			$content[] = $thread;		}	}}//************* Do Replies **************if($_REQUEST['mode'] > 1) {	$where = '';	foreach ($threadBox['sql']['where'] as $key => $value) if($value) $where .= ($where ? ' AND ' : ' WHERE ').$value;	if($_REQUEST['mode'] == 3 && $_REQUEST['uid']) {		$temp = '';		$sql = "SELECT p.id FROM forum_posts p, forum_threads t ".$where." AND p.tid = t.id AND p.userId = ".dbStr($_REQUEST['uid']).''.str_replace(array('userId','groupId'),array('t.userId','t.groupId'),$_SESSION['plexpediaGroup']['sql']).$threadBox['extra'];		if($rs = $_SERVER['db']->execute($sql)) while ($thread = $rs->FetchRow()) $temp .= ($temp ? ' OR ' : '').'p.pid = '.$thread['id'];		$where .= ' AND (t.userId = '.dbStr($_REQUEST['uid']).' OR ('.$temp.'))';	}	$threadBox['sql']['order'] = " ORDER BY `submitTime` DESC";	//$threadBox['sql']['order'] = " ORDER BY `state` ASC, `time` DESC";	$sql = "SELECT p.id, p.tid, p.title, p.userId, p.text, p.date, t.title AS threadTitle FROM forum_posts p, forum_threads t ".$where." AND p.tid = t.id ".str_replace(array('userId','groupId'),array('t.userId','t.groupId'),$_SESSION['plexpediaGroup']['sql']).$threadBox['sql']['order'].' LIMIT 25';	if(!$rs = $_SERVER['db']->execute($sql)) error('The database is experiencing errors.','fatal');	if($items += $rs->RecordCount()) {		//$page['pagination'] = func(_mod.'pagination','pagination',$items,25);		//if($items > 50) {			//$sql .= " ";			//$rs = $_SERVER['db']->execute($sql);		//}		while ($thread = $rs->FetchRow()) {			$thread['link'] = 'http://'.$_SERVER['HTTP_HOST'].'/view-id-'.$thread['tid'].'-c-'.$thread['id'].'#'.$thread['id'];			if($_REQUEST['mode'] != 3) $thread['type'] = 'Reply';			$thread['time'] = $thread['date'];			$thread['text'] = '<i>(In Thread <a href="http://'.$_SERVER['HTTP_HOST'].'/view-id-'.$thread['tid'].'">'.$thread['threadTitle'].'</a>)</i><br /><br />'.$thread['text'];			$content[] = $thread;		}	}}//Send vars to templatesetPageTpl('export');setPageConsts(array('page'=>$page,'items'=>$content),'export');?>