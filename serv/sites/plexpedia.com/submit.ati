<?//******************************************************************************//************ Section 1, set up initial variables and validate user! **********//******************************************************************************//<a title="Send a Private Message to '.$_SESSION['plexpediaGroup']['userId'].'" rel="nofollow" href="">Your '.$_SESSION['plexpediaGroup']['name'].' Group</a>').'">Contact the Group Administrator</a>if($_SESSION['plexpediaGroup']['access'] == '2') {	if(!isLoggedIn()) redirect('/user/login','<b>You need a invitation to submit in this group.</b><br /><i>If you don\'t already have an account, please click "Register For Free"!',1,true);	else if($_SESSION['plexpediaGroup']['usId'] != $_SESSION['userId'] && !isAdmin() && !$_SERVER['db']->getOne('SELECT groupId FROM group_members WHERE userId = "'.$_SESSION['userId'].'" AND groupId = "'.$_SESSION['plexpediaGroup']['id'].'"')) redirect('/user/pm-mode-send-username-'.encrypt($_SESSION['plexpediaGroup']['userName'],'url').'-subject-'.encrypt('Requesting permission to submit in '.$_SESSION['plexpediaGroup']['name'].' group','url').'-text-'.encrypt('Hi!<br /><br />I just registered for an account, and would like permission to submit.<br />I believe I will be an asset to the community because:<br /><br /><br /><br />-'.$_SESSION['userName'],'url').'-regarding-'.encrypt('<a href="http://'.$_SERVER['FAKE_HOST'].'/index','url'),'<b>You are successfully registered!</b><br /><i>In order to submit, please request permission from the group administrator.<br />They should contact you once you have been added to the access list!</i>',1,true);}else loginCheck('<b>Please Register or Login to Add Content:</b><br /><i>Account creation is quick, easy, and helps keep everything organized.</i>','end');if(!$_SESSION['plexpediaGroup']['userCanSubmit']) redirect('/index','This group\'s access settings don\'t currently permit the submission of new content.');setPageConst('simplified', true);SetPageConst('showAds',false,'skin');setPageConst('title','Adding Content');//setPagePref('deadEndPage','true');if($_REQUEST['cat']) $_SESSION['forumLastCategory'] = $_REQUEST['cat'];if($_REQUEST['id']) {  //Make sure they are editing their OWN item :)	$item = $_SERVER['db']->getRow("SELECT * FROM forum_threads WHERE id=".$_REQUEST['id']);	if((isAdmin() || (isModerator() && $item['groupId'] == $_SESSION['plexpediaGroup']['id'])) && $_REQUEST['setstate']) {		$sql = $_SERVER['db']->execute('			INSERT INTO mod_log SET			userId = \''.$_SESSION['userId'].'\',			groupId = '.$_SESSION['plexpediaGroup']['id'].',			date = '.time().',			summary = '.dbStr($_SESSION['userFullName'].' set <a href="/view-'.$item['id'].'">'.strip_tags($item['title']).'</a> to "'.$_REQUEST['setstate'].'"').'		');	}	else if((isAdmin() || (isModerator() && $item['groupId'] == $_SESSION['plexpediaGroup']['id'])) && $_REQUEST['setcat']) {		$sql = $_SERVER['db']->execute('			INSERT INTO mod_log SET			userId = \''.$_SESSION['userId'].'\',			groupId = '.$_SESSION['plexpediaGroup']['id'].',			date = '.time().',			summary = '.dbStr($_SESSION['userFullName'].' moved <a href="/view-'.$item['id'].'">'.strip_tags($item['title']).'</a> to category "'.$_REQUEST['setcat'].'"').'		');	}        else if($item['state'] == 'removed') error('This item has been removed by a site moderator. Should you have any questions about this action, please consult the Mod Log at /log','fatal');	else if ($_SESSION['userId'] != $item['userId'] && !isAdmin()) error('You could not be authenticated as the author of this item','fatal');}else {	$item['id'] = $_SERVER['db']->getOne("SELECT id FROM forum_threads WHERE submitTime = '0' AND time < '".(time() - 604800)."'"); //overwrite "dud" items over 1 week old	if($item['id']) { //"dud" item available... clean it up for use!		$sql = $_SERVER['db']->execute('			REPLACE INTO forum_threads SET			id = '.$item['id'].',			userId = \''.$_SESSION['userId'].'\',			type = \'\',			cid = \'\',			title = \'\', 			text = \'\',			state = \'hidden\',			description = \'\',			submitTime = \'\',			picture = \'\',			time = '.time().',			groupId = \'\'		');	}}//If some code above hasn't assigned an ID yet (we aren't editing or using a dud row), create new row in DBif(!$item['id']) {	$sql = $_SERVER['db']->execute('INSERT INTO forum_threads (userId) VALUES (\''.$_SESSION['userId'].'\')');	$item['id'] = $_SERVER['db']->insert_id();}//*************************** Here We Go! ****************************if(isset($_REQUEST['setcat'])) {	//if(!$_SESSION['groupName']) {	//	if($_SERVER['db']->getOne('SELECT minPowerSubmit FROM '.catTable.' WHERE id = '.$_REQUEST['setcat'].'') > $_SESSION['userPower']) redirect($_SESSION['lastPage'],'You do not have permession to submit in the category you selected');	//}	//else {		$access = $_SERVER['db']->getOne('SELECT access FROM '.catTable.' WHERE id = '.$_REQUEST['setcat'].'');		if($access == '2' || $access == '3') {			if(!isLoggedIn()) redirect($_SESSION['lastPage'],'You do not have permession to submit in the category you selected');			else if(!isAdmin() && $_SESSION['plexpediaGroup']['usId'] != $_SESSION['userId'] && !$_SERVER['db']->getOne('SELECT groupId FROM group_members WHERE userId = "'.$_SESSION['userId'].'" AND groupId = "'.$_SESSION['plexpediaGroup']['id'].'"')) redirect($_SESSION['lastPage'],'You do not have permission to submit in the category you selected');		}	//}		$sql = $_SERVER['db']->execute('		UPDATE forum_threads SET		cid = '.dbStr($_REQUEST['setcat']).',		tags = \'\',		time = \''.time().'\',		groupId = \''.($_SESSION['plexpediaGroup']['id'] ? $_SERVER['db']->getOne('SELECT groupId FROM '.catTable.' WHERE id = '.$_REQUEST['setcat'].'') : '').'\'		WHERE id = \''.$item['id'].'\'	');	$item['cid'] = $_REQUEST['setcat'];	if($_REQUEST['rdr']) redirect($_SESSION['lastPage']);}if($_REQUEST['settype']) {	if($_SERVER['plexDataTypes'][$_REQUEST['settype']]['a'] == 'm' && !$_SESSION['plexpediaGroup']['userCanModerate']) error('Irrational page typeset privilege cyclic redundancy check fault','fatal');	$sql = $_SERVER['db']->execute('		UPDATE forum_threads SET		type = '.dbStr($_REQUEST['settype']).',		tags = \'\',		time = \''.time().'\'		WHERE id = \''.$item['id'].'\'	');			$item['type'] = $_REQUEST['settype'];	$item['cid'] = '';	if($_SESSION['forumShowMode'] != 'all') $_SESSION['forumShowMode'] = $_REQUEST['settype'];}if($_REQUEST['setstate']) {		if(strtolower($_REQUEST['setstate']) == "sticky" && !isAdmin() && !isModerator()) error('Higher security clearance needed to alter thread state');	$sql = $_SERVER['db']->execute('		UPDATE forum_threads SET		state = '.dbStr(strtolower($_REQUEST['setstate'])).',		time = \''.time().'\'		WHERE id = \''.$item['id'].'\'	');	redirect($_SESSION['lastPage']);}if (!$item['type'] || $_REQUEST['changetype']) {  //Make sure they're editing SOMETHING :)		setPage('	<style type="text/css">	.submissionlinks { width:650px; margin:auto; height:350px; margin-top:10px; }	.submissionlink, .submissionlink:hover {		display:block;		width:210px;		padding:25px;		margin-top:10px;		float:left;		text-decoration:none;	}	.submissionlink img { float:none; }	.submissionlink .title { font-weight:bold; font-size:1.2em; }	</style>	','head');		$temp = '';	foreach($_SERVER['plexDataTypes'] as $key=>$val) {		if(			$val['a'] == 'd' || //deprecated			($val['a'] == 'm' && !$_SESSION['plexpediaGroup']['userCanModerate']) ||			($val['a'] == 'g' && !$_SESSION['plexpediaGroup']['id'])			) continue;		$temp .= '<a href="/submit-settype-'.$key.'-id-'.$item['id'].'" class="submissionlink">			<img src="/img/icon'.$key.'.png">			<div class="title">'.$val['n'].'</div>			<div class="desc">'.$val['d'].'</div>		</a>';		//$_SESSION['groupName'] && $_SERVER['db']->getOne('SELECT id FROM group_categories WHERE type = \'bug\''.$_SESSION['plexpediaGroup']['sql'])	}		setPageBlock('blockFancy','Select Content Type','		<div class="caln">'.$_SESSION['plexpediaGroup']['text']['sub'].'</div>		<div class="submissionlinks llst">			'.$temp.'		</div>	');		buildPage();}$itemCategories = 0;if ($_SESSION['groupName']) {	if($temp = $_SERVER['db']->execute('SELECT id FROM group_categories WHERE (type = \'\' OR type = \''.$item['type'].'\')'.$_SESSION['plexpediaGroup']['sql'])) $itemCategories = $temp->recordCount();}if($itemCategories == 1 && !$item['cid']) { //One possible category, pick it for them	$item['cid'] = $_SERVER['db']->getOne('SELECT id FROM group_categories WHERE (type = \'\' OR type = \''.$item['type'].'\')'.$_SESSION['plexpediaGroup']['sql']);	$sql = $_SERVER['db']->execute('		UPDATE forum_threads SET		cid = '.dbStr($item['cid']).',		groupId = \''.($_SESSION['plexpediaGroup']['id'] ? $_SERVER['db']->getOne('SELECT groupId FROM '.catTable.' WHERE id = '.$item['cid'].'') : '').'\'		WHERE id = \''.$item['id'].'\'	');}else if($itemCategories > 1 && ($item['cid'] == "" || $_REQUEST['changecat'])) {  //Let them pick a category		setPage('	<style type="text/css">	.catselect { padding-left:50px; width:40%; float:left; min-height:300px; }	.catselect .dtree { width:300px; margin:auto; display:block; line-height:16px; text-align:left; }	.catselect .dtree .node, .catselect .nodeSel, .catselect .nodeSel:hover { text-decoration:none; display:block; width:80%; }	.catselect .dtree .node:hover, .catselect .nodeSel:hover { background-color:#FFFFFF; }	.catselect .dtree img { float:left; }	.catselect .dTree a.nodeSel { font-weight:bold; }	</style>	','head');		setPageBlock('blockFancy','Select Category','	<br />		<div class="catselect">		'.func(_fnc.'categorylist','categorySelect','/submit-id-'.$item['id'].'-setcat-',($_SESSION['groupName'] ? 'AND (type = \'\' OR type = \''.$item['type'].'\')' : '')).'	</div>			'.($_SESSION['plexpediaGroup']['text']['cat'] ? $_SESSION['plexpediaGroup']['text']['cat'] : '	<div>How to select a category:</div>	<div class="stxt">		<ol>			<li>Click the <b>+</b> icon next to the category that best matches your '.$_SERVER['plexDataTypes'][$item['type']]['n'].'</li>			<li>Continue till you have reached the most specific category possible</li>			<li>Click on a category to place your '.$_SERVER['plexDataTypes'][$item['type']]['n'].' in it</li>		</ol>	</div>	').'		<br clear="all" />	'	);		buildPage();}//****************************************************************************************//************************************* Content Editing **********************************//****************************************************************************************$item = $_SERVER['db']->getRow("SELECT * FROM forum_threads WHERE id = {$item['id']}");if(!$_POST['tags']) { //if(!array_key_exists('tags',$_POST)) {	$_POST['tags'] = str_replace(';',', ',$item['tags']);	if(!$_POST['tags']) {		$_POST['tags'] .= $_SESSION['groupName'].', '.$_SESSION['userName'];		if($item['cid']) {			if($_POST['tags']) $_POST['tags'] .= ', ';			$_POST['tags'] .= func(_mod.'dbtree','getPathFromId',catTable,$item['cid'],', ');		}		else $_POST['tags'] .= ', '.$_SERVER['plexDataTypes'][$item['type']]['p'];	}	if($_POST['tags']) $_POST['tags'] .= ', '; //Make sure there is a comma somewhere in the list so we don't switch to spaces parsing}if(!$_POST['title']) $_POST['title'] = strip_tags($item['title']);if(!$_POST['longTitle']) $_POST['longTitle'] = $item['description'];if(!$_POST['text']) $_POST['text'] = $item['text'];if(!$_POST['state']) $_POST['state'] = $item['state'];if($_SESSION['plexpediaGroup']['access'] == 3) {	if(!$_POST['access']) $_POST['access'] = ($item['access'] ? $item['access'] : 2); //Private unless otherwise specified}else if($_SESSION['plexpediaGroup']['access'] == 2 || $_SESSION['plexpediaGroup']['access'] == 4) {	if(!$_POST['access']) $_POST['access'] = $item['access']; //Public unless otherwise specified}else $_POST['access'] = 1;if(!$item['submitTime']/* && !$_POST['state']*/) $_POST['state'] = 'active'; //First Submission, Make it Publicif($_REQUEST['submitted'] == true) { //They clicked "Submit!"	if($_POST['submit'] == 'Change' || $_POST['submit'] == '<< Alter Content Type' || $_POST['submit'] == '>> Save & Continue Editing') { //They are changing something, preserve post data!		$_POST['state'] = 'hidden';	}	else  {	 //They Are submitting item for real		if(!$_POST['title'])				$errors .= "<li>You forgot to enter the Title!</li>";		//if(!$_POST['longTitle'])			$_POST['longTitle'] = strip_tags(substr($_POST['text'], 0, 75));				if($item['type'] == 'pic') {			$image = func(_mod.'imageuploader','imageuploader','imageLocation',1024,768);			if ($image == 1) $errors .= "<li>You forgot to select an image file.<br /><em>(Please click the browse button)</em></li>";			else if ($image == 2) $errors .= "<li>The file you selected was not an image.<br /><em>(Please select a different file)</em></li>";			else if ($image == 3) $errors .= "<li>Errors were experienced while processing your image.<br /><em>(Please try converting your image to a different format using an image editor)</em></li>";			else {				$_POST['text'] = $image;				$item['picture'] = func(_mod.'imageuploader','getThumbnailImageName',$image);			}		}		else {			if($_FILES['imageLocation']['size']) {				$image = func(_mod.'imageuploader','imageuploader','imageLocation','thumb');				if ($image == 1) $errors .= "<li>You forgot to select an image file.<br /><em>(Please click the browse button)</em></li>";				else if ($image == 2) $errors .= "<li>The file you selected was not an image.<br /><em>(Please select a different file)</em></li>";				else if ($image == 3) $errors .= "<li>Errors were experienced while processing your image.<br /><em>(Please try again)</em></li>";				else {					$item['picture'] = $image;				}			}			else if(!$item['picture']) {				if(preg_match('/\<img([^c]*)class\=\"imgx\" src=\"([^\"]*)\"([^\>]*)\>/', $_POST['text'], $image)) {					$thumb = func(_mod.'imageuploader','getThumbnailImageName',$image[2]);					if(file_exists($thumb)) $item['picture'] = $thumb;					else {						$item['picture'] = func(_mod.'imageuploader','imageScraper',$image[2],'thumb');					}				}			}			if(strlen($_POST['text']) < 5)		$errors .= "<li>Your item needs some Text!</li>";		}				if(!$item['submitTime']) $item['submitTime'] = time(); //submitting for the first time	}	if($errors) {		$errors = '<div class="ebox">There were difficulties submitting your '.$_SERVER['plexDataTypes'][$item['type']]['n'].':<ul>'.$errors.'</ul></div>';	}	else {				if($_POST['tags']) {			if(strpos($_POST['tags'],',')) $_POST['tags'] = str_replace(array(' , ',', ',' ,'	,','),';',$_POST['tags']);			else $_POST['tags'] = trim(str_replace(array('  ',' '),';',$_POST['tags']));			if($_POST['tags']{strlen($_POST['tags']) - 1} == ';') $_POST['tags'] = substr($_POST['tags'],0,strlen($_POST['tags']) - 1); //Remove trailing ","		}				if(strtolower($_POST['state']) == "sticky" && !isAdmin() && !isModerator() && $item['state'] != "sticky") error('Higher security clearance needed to alter thread state');				$sql = $_SERVER['db']->execute('			UPDATE forum_threads SET			tags = '.dbStr(strip_tags($_POST['tags'])).', 			title = '.dbStr(strip_tags($_POST['title'])).', 			text = '.dbStr(doTxt($_POST['text'])).', 			state = '.dbStr(strtolower($_POST['state'])).', 			description = '.dbStr($_POST['longTitle']).',  			submitTime = \''.$item['submitTime'].'\', 			picture = '.dbStr($item['picture']).',			groupId = '.dbStr(($item['groupId'] ? $item['groupId'] : $_SESSION['plexpediaGroup']['id'])).', 			access = '.dbInt($_POST['access']).', 			time = \''.time().'\' 			WHERE id = \''.$item['id'].'\'		');				$_POST['tags'] = str_replace(';', ', ', $_POST['tags']);				if($sql) { //It Worked!			if($_POST['submit'] == 'Change') redirect('/submit-changecat-true-id-'.$item['id'].'');			if($_POST['submit'] == '<< Alter Content Type') redirect('/submit-changetype-true-id-'.$item['id'].'');			else if($_POST['submit'] != '>> Save & Continue Editing') redirect('/view-'.$item['id'].'',''); //Your Item Was Submitted Successfully!		}	   else {   //It Didn't :(		  error('Error inserting your information into the database: '.$_SERVER['db']->ErrorMsg().'<br /><br />This may be due to the fact that the database server has just consumed two dozen boxes of doughnuts, and stayed up all night playing chess against itself','fatal');	   }	}}if($item['picture']) $thumbNailImage = '<img style="float:left;" src="'.$item['picture'].'" />';setPageBlock('blockFancy',($item['submitTime'] ? 'Updating' : 'Adding').' your '.$_SERVER['plexDataTypes'][$item['type']]['n'],''.$welcomeMessage.'	<div class="caln">'.$_SESSION['plexpediaGroup']['text'][$item['type']].'</div>	<form enctype="multipart/form-data"  method="post" action="/submit">	'.$errors.'	  <table class="outer">		'.($item['cid'] ? '		<tr> 		  <td class="lcol desc">Category:		  <td class="rcol desc">'.($itemCategories > 1 ? '<input name="submit" type="submit" value="Change" class="button" style="width:100px; float:right;">' : '').func(_mod.'dbtree','getPathFromId',catTable,$item['cid']).'</td>		</tr>		' : '').'		<tr>		  <td class="lcol desc">Tags:</th>		  <td class="rcol"><input class="input" name="tags" type="text" value="'.$_POST['tags'].'" size="50" maxlength="200" width="70"></td>		</tr>		<tr>		  <td class="lcol">Title:</th>		  <td class="rcol"><input class="input" name="title" type="text" id="title" value="'.$_POST['title'].'" size="50" maxlength="75" width="70"></td>		</tr>		'.($item['type'] != 'pge' ? '		<tr>		  <td class="lcol desc">Description:</th>		  <td class="rcol">			<input class="input" name="longTitle" type="text" id="longTitle" value="'.$_POST['longTitle'].'" size="50" maxlength="100" width="70"></td>		</tr>		' : '').'		'.($item['type'] == 'med' ? '			<tr> 			  <td class="lcol">HTML:</th>			  <td class="rcol"><textarea class="input" name="text" type="text">'.$_POST['text'].'</textarea></td>			</tr>			<tr>			  <td class="lcol desc">Mini Photo:</td>			  <td class="rcol">				'.$thumbNailImage.'				<input name="imageLocation" id="imageLocation" type="file" style="margin-left:0px;"/>			  </td>			</tr>		' : ($item['type'] == 'lnk' ? '			<tr> 			  <td class="lcol">Url:</th>			  <td class="rcol"><input class="input" name="text" type="text"value="'.$_POST['text'].'" size="50" maxlength="200" width="70"></td>			</tr>		' : ($item['type'] == 'aud' ? '			<tr>			  <td class="lcol">Url:</th>			  <td class="rcol"><input class="input" name="text" type="text"value="'.$_POST['text'].'" size="50" maxlength="200" width="70"></td>			</tr>			<tr>			  <td class="desc" colspan="2">			  	<div class="nbox">			  		<ol><li>Upload your audio file to the internet. Sites like <a href="http://www.zshare.net" target="_blank">zShare</a>, <a target="_blank" href="http://www.archive.org">Archive.org</a>, or <a href="https://www.box.net">Box.net</a> work great for this.</li><li>Copy the direct link to your uploaded audio file into the URL field above.<div class="stxt">(not the download page - the DIRECT LINK to the AUDIO FILE)</div></li><li>Press "Submit Audio" to share your sound with the world!</ol>					<ul><li>Note: Only .mp3 files are supported. You will need to <a href="http://media-convert.com/" target="_blank">convert</a> your audio to .mp3 before posting.</li></ul>				</div>			</th>			</tr>		' : ($item['type'] == 'pic' ? '			<tr>			  <td class="lcol">Photo File:</td>			  <td class="rcol">				<br /><input name="imageLocation" id="imageLocation" type="file" style="margin-left:0px;"/><br />				'.($item['text'] ? '<img style="max-width:400px;" src="'.$item['text'].'" />' : '').'			  </td>			</tr>		' : '			<tr> 			  <td class="lcol">Text:</th>			  <td class="rcol">'.func(_mod.'textbox', 'textbox', 'text', $_POST['text']).'</td>			</tr>			'.($item['type'] != 'pge' ? '			<tr>			  <td class="lcol desc">Mini Photo:</td>			  <td class="rcol">				'.$thumbNailImage.'				<input name="imageLocation" id="imageLocation" type="file" style="margin-left:0px;"/>			  </td>			</tr>			' : '').'		')))).'		'.($_SESSION['plexpediaGroup']['access'] != 1 ? '		<tr>		  <td class="lcol">Access:</th>		  <td class="rcol"><select name="access"><option value="1"'.($_POST['access'] == 1 ? ' selected' : '').'>Public: Visible to Everyone</option><option value="2"'.($_POST['access'] == 2 ? ' selected' : '').'>Private: Visible only to Group Access List</option></select></td>		</tr>		' : '').'		<tr>		  <td class="lcol">Status:</th>		  <td class="rcol"><select name="state" class="input"><option>Active</option><option'.(strtolower($_POST['state']) == 'hidden' ? ' selected' : '').'>Hidden</option><option'.(strtolower($_POST['state']) == 'resolved' ? ' selected' : '').'>Resolved</option>'.(strtolower($_POST['state']) == 'sticky' ? '<option selected>Sticky</option>' : '').'</select></td>		</tr>	  </table>	  	  <br />	  <input name="submitted" type="hidden" id="submitted" value="true">	  <input name="id" type="hidden" id="id" value="'.$item['id'].'">	  <input name="submit" type="submit" class="bold" value="'.($item['submitTime'] ? 'Update' : 'Submit').' '.$_SERVER['plexDataTypes'][$item['type']]['n'].'">	  <input name="submit" type="submit" value=">> Save & Continue Editing" style="width:49%;" class="rflt">	  <input name="submit" type="submit" value="<< Alter Content Type" style="width:49%;" class="lflt">	  <br />	  	 </form>');buildPage();?>