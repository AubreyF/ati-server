<?//***************** VALIDATE USER, AND SET SOME INIT VARS ************************if(!$_SESSION['plexpediaGroup']['userCanComment']) redirect($_SESSION['lastPage'],'We\'re sorry, but this group only accepts comments from users who have prior permission.');if(!isLoggedIn()) {	if($_SESSION['plexpediaGroup']['access'] == 3 || $_SESSION['plexpediaGroup']['access'] == 2) loginCheck('<b>This group requires prior permission to comment in.</b><br /><i>If you are on the "access list", please log in to your account.</i>','end');	else loginCheck('<b>Please register an account in order to comment.</b><br /><i>It\'s easy, free, helps keep everything organized, and takes less than 30 seconds!</i>','end');}//die(print_r($_SESSION['plexpediaGroup'],true));if(!$_REQUEST['tid']) redirect($_SESSION['lastPage'],'The Thread Id was not present!');$thread = $_SERVER['db']->getRow("SELECT * FROM forum_threads WHERE id=".$_REQUEST['tid']);if(!$thread) redirect($_SESSION['lastPage'],'The the thread could not be found!');if($thread['access'] == 2 && $thread['groupId'] != $_SESSION['plexpediaGroup']['id']) redirect('/index','Sorry, but you did not have read authorization for that content');//tid = thread id (article)//pid is post id (in reply to)//id is post id (when editing)if($_REQUEST['setstate']) {	if(!isAdmin() && !(isModerator() && $_SERVER['db']->getOne("SELECT groupId FROM forum_threads WHERE id=".$_REQUEST['tid']) == $_SESSION['plexpediaGroup']['id'])) error('Higher security clearance needed to alter post state');	$sql = $_SERVER['db']->execute('		INSERT INTO mod_log SET		userId = \''.$_SESSION['userId'].'\',		groupId = '.$_SESSION['plexpediaGroup']['id'].',		date = '.time().',		summary = '.dbStr($_SESSION['userFullName'].' set comment <a href="/view-id-'.$_REQUEST['tid'].'-c-'.$_REQUEST['id'].'#comment">'.strip_tags($_SERVER['db']->getOne("SELECT title FROM forum_posts WHERE id=".$_REQUEST['id'])).'</a> to "'.$_REQUEST['setstate'].'"').'	');		$sql = $_SERVER['db']->execute('		UPDATE forum_posts SET		state = '.dbStr(strtolower($_REQUEST['setstate'])).'		WHERE id = '.dbInt($_REQUEST['id']).' AND tid = '.dbInt($_REQUEST['tid']).'	');		redirect($_SESSION['lastPage'].'#c'.$_REQUEST['id']);}if($_REQUEST['id']) {	if ($_SESSION['userId'] != $_SERVER['db']->getOne("SELECT userId FROM forum_posts WHERE id=".$_REQUEST['id']) && !isadmin()) error('You could not be authenticated as the author of this post.','fatal'); 		$reply = $_SERVER['db']->getRow("SELECT * FROM forum_posts WHERE id=".$_REQUEST['id']);		if (!$_REQUEST['pid']) $_REQUEST['pid'] = $reply['pid'];	if(!$_POST['title'] && !$_POST['text']) {		$_POST['title'] = $reply['title'];		$_POST['text'] = $reply['text'];	}}if($_REQUEST['pid']) $previousPost = '<div class="caln stxt" style="margin-top:70px;">Replying to:</div>'.pfunc('blockComment',$_SERVER['db']->getRow("SELECT * FROM forum_posts WHERE id=".$_REQUEST['pid']));else $previousPost = '<div class="caln stxt" style="margin-top:70px;">Replying to:</div>'.pfunc('blockComment',$_SERVER['db']->getRow("SELECT * FROM forum_threads WHERE id=".$_REQUEST['tid']));if($_REQUEST['pid'] && !$_POST['title']) $_POST['title'] = 'Re: '.str_replace('Re: ','',$_SERVER['db']->getOne("SELECT title FROM forum_posts WHERE id=".$_REQUEST['pid']));else if(!$_POST['title']) $_POST['title'] = 'Re: '.str_replace('Re: ','',$thread['title']);//***************************** USER VALIDATED *******************************if ($_POST['submit']) {		//***********************  THREAD HAS BEEN SUBMITTED! *****************************		//if(!$_POST['title']) $errors .= "<li>You forgot to enter the Title!</li>";	if(!$_POST['title'])	$_POST['title'] = strip_tags(substr($_POST['text'], 0, 50));	if(!$_POST['text'] || strlen($_POST['text']) < 10)		$errors .= "<li>Your Comment will bore people without some text...</li>";		$_POST['title'] = stripslashes($_POST['title']);	$_POST['text'] = stripslashes($_POST['text']);	$usId = ($reply['userId'] ? $reply['userId'] : $_SESSION['userId']);		if($noSubmit = $_SERVER['db']->getOne('SELECT id FROM forum_posts WHERE title = '.dbStr($_POST['title']).' AND tid = '.dbInt($_REQUEST['tid']).' AND text = '.dbStr($_POST['text']).' AND userId = \''.$usId.'\'')) true;	else if($_SERVER['db']->getOne('SELECT id FROM forum_posts WHERE userId = \''.$usId.'\' AND date > '.(time() - 30))) $errors .= "<li>You have posted to this site within 30 seconds. Please make sure that this posting isn't a duplicate!</li>";		if(!$errors) { // All checks have passed, insert thread into the database!				if($noSubmit) redirect('/view-id-'.$_REQUEST['tid'].'-c-'.$noSubmit.'#c'.$noSubmit); //This is an exact double posting		else if(dbReplace('site','forum_posts',array(			'id'=> $_REQUEST['id'],			'pid'=> $_REQUEST['pid'],			'tid'=> $_REQUEST['tid'],			'title'=> $_POST['title'],			'text'=> doTxt($_POST['text']),			'date'=> $reply['date'] ? $reply['date'] : time(),			'userId'=> $usId,		))) {			$_SERVER['db']->execute('UPDATE `forum_threads` SET `time`='.time().' WHERE `id` = '.$_REQUEST['tid']); //update this item's read time			redirect('/view-id-'.$_REQUEST['tid'].'-c-'.$_SERVER['db']->insert_id().'#c'.$_SERVER['db']->insert_id());		}				else $errors .= 'Error inserting your information into the database: '.$_SERVER['db']->ErrorMsg().'</li>';	}	if($errors) $errors = '<div class="ebox"><h4>There were errors with your submission:</h4><ul>'.$errors.'</ul></div>';}//There were errors, or this was the first time throughsetPageConst('title','Adding Reply in "'.$thread['title'].'"');SetPageConst('showAds',false,'skin');//setPageConst('bct','<a href="/index">Home</a> > Adding Reply to "'.$thread['title'].'!');setPageBlock('blockFancy','Replying in "'.$thread['title'].'"','<a style="float:right;" href="'.$_SESSION['lastPage'].'">Â« Cancel Reply</a><br /><br /><form method="post">'.$errors.'<table class="outer" width="100%">	<tr>	  <td class="lcol">Title:</td>	  <td class="rcol"><input class="input" name="title" type="text" value="'.$_POST['title'].'" maxlength="70"></td>	</tr>	<tr>	  <td class="lcol">Text:</td>	  <td class="rcol">'.func(_mod.'textbox', 'textbox', 'text', $_POST['text']).'</td>	</tr></table><div class="boldBorder"><input type="submit" id="submit" name="submit" value="'.($_REQUEST['id'] ? 'Update' : 'Submit').' Reply!" class="bold" /></div></form>'.$previousPost);?>