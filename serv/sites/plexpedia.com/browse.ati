<?//Make all pages bookmarkable!if($_POST) redirect(generate_url());//Type Specific Categoriesif($_SESSION['groupName']) $bugCat = $_SERVER['db']->getRow('SELECT * FROM group_categories WHERE type = \'bug\''.$_SESSION['plexpediaGroup']['sql']);//Misc init...if($_REQUEST['searchCategory'] == 'last') $_REQUEST['cat'] = $_SESSION['forumLastCategory'];if($_REQUEST['cat']) $page['category'] = $_SERVER['db']->getRow('SELECT * FROM '.catTable.' WHERE id = '.$_REQUEST['cat']);if($_REQUEST['tag']) $_REQUEST['t'] = $_REQUEST['tag'];//Show Mode//if($_REQUEST['show'] == 'all') $_SESSION['forumShowMode'] = '';//else if($_REQUEST['show']) $_SESSION['forumShowMode'] = $_REQUEST['show'];/*if($_SESSION['forumShowMode'] == 'nws') {	$threadBox['type'] = 'News';} else if($_SESSION['forumShowMode'] == 'art') {	$threadBox['type'] = 'Articles';} else if($_SESSION['forumShowMode'] == 'dat') {	$threadBox['type'] = 'Data Facts';} else if($_SESSION['forumShowMode'] == 'deb') {	$threadBox['type'] = 'Debates';} else if($_SESSION['forumShowMode'] == 'dis') {	$threadBox['type'] = 'Discussions';} else if($bugCat && $_SESSION['forumShowMode'] == 'bug' && ($_REQUEST['show'] == 'bug' || $page['category']['type'] == 'bug')) {	//if(!$_REQUEST['cat']) redirect('/browse-cat-'.$bugCat['id']);	$threadBox['type'] = 'Bugs';} else {	$threadBox['type'] = 'All';}if($threadBox['type'] != 'All') {	$threadBox['noItemsErrorResolve'] .= '<li><a href="'.do_url('show','all').'">Viewing <b>All</b> items.</a></li>';}*/$page['bct'] = '<a href="/index">Home</a> > <a href="/browse">'.$_SESSION['plexpediaGroup']['text']['contentName'].'</a>';//Misc Sql$threadBox['sql']['where'][] = "(`state` = 'active' OR `state` = 'resolved' OR `state` = 'sticky')";//Order byif($_REQUEST['order']) {	if ($_REQUEST['order'] == 'dateOld')		$threadBox['sql']['extra'] .= ' ORDER BY date ASC';	else if ($_REQUEST['order'] == 'dateNew')	$threadBox['sql']['extra'] .= ' ORDER BY date DESC';	else if ($_REQUEST['order'] == 'title')	$threadBox['sql']['extra'] .= ' ORDER BY title DESC';}//Generate Page Title and dataif(!$_REQUEST['show']) $page['title'] = $_SESSION['plexpediaGroup']['text']['contentName'];//'All';else {	$page['title'] = $_SERVER['plexDataTypes'][$_REQUEST['show']]['p'];	$page['bct'] .= ' > '.$_SERVER['plexDataTypes'][$_REQUEST['show']]['p'];	$threadBox['sql']['where'][] = "`type` = '{$_REQUEST['show']}'";}//Inside Categoryif($page['category']['id']) {	if($page['category']['access'] == '3') {		if(!isLoggedIn()) redirect('/user/login','This is an "Invite Only" group. If you have an invitation, please login!');		else if(!isAdmin() && !$_SERVER['db']->getOne('SELECT groupId FROM group_members WHERE userId = "'.$_SESSION['userId'].'" AND groupId = "'.$_SESSION['plexpediaGroup']['id'].'"')) redirect('/nopermission');	}		$_SESSION['forumLastCategory'] = $page['category']['id'];		if($childCategories = func(_mod.'dbtree','getAllChildren',catTable,$_REQUEST['cat'])) foreach($childCategories as $key=>$id) {		$subCategories .= " || (`cid` = '{$id}')";	}	$threadBox['sql']['where'][] = "((`cid` = '{$_REQUEST['cat']}'){$subCategories})";		$page['title'] .= ' > '.func(_mod.'dbtree','getPathFromId',catTable,$_REQUEST['cat']);		$threadBox['noItemsErrorResolve'] .= '<li><a href="/browse-cat-'.$page['category']['parent'].'">Viewing a higher category</a></li>';}else $_REQUEST['cat'] = 0;/*//Inside category or group - group is now necessary as items are connected to groups by category and not by groupid, which allows "syndicats" to work betterif($page['category']['id'] || $_SESSION['groupName']) {	if($childCategories = func(_mod.'dbtree','getAllChildren',catTable,$_REQUEST['cat'])) foreach($childCategories as $key=>$id) {		if($id || !$_SESSION['groupName'])	$subCategories .= " || (`cid` = '{$id}')";		else { //Top Level, in group - need to bind top level to group id as all groups share "category" 0			$subCategories .= '(`cid` = 0 && `groupid` = '.$_SESSION['plexpediaGroup']['id'].')';		}	}	$threadBox['sql']['where'][] = "((`cid` = '{$_REQUEST['cat']}'){$subCategories})";}*///Doing boolean searchif($_REQUEST['all'] || $_REQUEST['none'] || $_REQUEST['any']) {	$_REQUEST['q'] = '';	if($_REQUEST['all'])  $_REQUEST['q'] .= '+('.$_REQUEST['all'].')';	if($_REQUEST['none']) $_REQUEST['q'] .= ' -('.$_REQUEST['none'].')';	if($_REQUEST['any'])  $_REQUEST['q'] .= ' '.$_REQUEST['any'];}//Doing a searchif($_REQUEST['q']) {	$threadBox['sql']['where'][] = "MATCH(title,description,tags,text) AGAINST (".dbStr($_REQUEST['q']).' IN BOOLEAN MODE)';	//$threadBox['sql']['where'][] = "MATCH(title,description,tags,text) AGAINST (".dbStr($_REQUEST['q']).')';		$page['title'] .= ' > Search : '.$_REQUEST['q'];	if($page['category']['id']) $page['bct'] .= ' > '.func(_mod.'dbtree','getLinkedPathFromId',catTable,$_REQUEST['cat'], '/browse','cat',true);	$page['bct'] .= ' > Search : '.$_REQUEST['q'];		$threadBox['noItemsErrorResolve'] .= '<li><a href="'.$_SERVER['FAKE_URI'].'">"Broadening" (or Removing) your search criteria</a></li>';}//Doing a searchelse if($_REQUEST['t']) {	$threadBox['sql']['where'][] = 'tags LIKE '.dbstr('%'.$_REQUEST['t'].'%');	$page['title'] .= ' > Tag : '.$_REQUEST['t'];	$page['bct'] .= ' > Tag : '.$_REQUEST['t'];		$threadBox['noItemsErrorResolve'] .= '<li><a href="'.$_SERVER['FAKE_URI'].'">"Broadening" (or Removing) your search criteria</a></li>';}//Not doing a searchelse {	if($_REQUEST['cat']) {		$page['bct'] .= ' > '.func(_mod.'dbtree','getLinkedPathFromId',catTable,$_REQUEST['cat'], '/browse','cat',false);		$catBox['title'] = $page['category']['title'].' subcategories';	}	else {		$catBox['title'] = 'Categories';	}		/*//Syndicats have been depricated in favour of the new & improved groupcats handled in /_pre.atii	if(strpos(',',$_SESSION['plexpediaGroup']['syndicats'])) $temp = explode($_SESSION['plexpediaGroup']['syndicats'],',');	else $temp = array(0=>$_SESSION['plexpediaGroup']['syndicats']);	if($temp) {		foreach($temp as $key=>$cat) $syndicats .= ' OR id = \''.$cat.'\'';		$syndicats = substr($syndicats, 4);	}	*/		if(!$threadBox['noItemsErrorResolve']) $threadBox['noItemsErrorResolve'] .= '<li>Items should be added soon!</li>';}//Organize SQL$temp = '';foreach ($threadBox['sql']['where'] as $key => $value) $temp .= ($temp ? ' AND ' : ' WHERE ').$value;if($_SESSION['plexpediaGroup']['text']['sort'] == 'a') $threadBox['sql']['order'] = " ORDER BY `state`='sticky' DESC, `state` ASC, `title` ASC";else $threadBox['sql']['order'] = " ORDER BY `state`='sticky' DESC, `state` ASC, `time` DESC";$threadBox['sql'] = "	SELECT t.id, t.title, t.type, t.tags, t.description, t.state, t.submitTime, t.userId, t.views, t.picture, t.time".	(isLoggedIn() ? ", r.readTime FROM forum_threads t LEFT JOIN forum_reads r ON(t.id = r.threadId AND r.readUser = '{$_SESSION['userId']}')" : ' FROM forum_threads t').	$temp.''.$threadBox['extra'].$_SESSION['plexpediaGroup']['sql'].$_SESSION['plexpediaGroup']['sqlContent'].$threadBox['sql']['order'];	//if(isAdmin()) test($threadBox['sql']);//test($threadBox['sql']);//******************************************************************************//************************** Set Vars to Template ******************************//******************************************************************************setPageTpl('browse');setPageConsts(array('page'=>$page,'threadBox'=>$threadBox,'catBox'=>$catBox),'browse');?>